<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil Kesejahteraan dan Personaliti Warga</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
        }
        .print-only { display: none; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="max-w-4xl mx-auto p-6 bg-white min-h-screen fade-in">
        <!-- Loading state -->
        <div class="text-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-4 text-gray-600">Memuatkan soal selidik...</p>
        </div>
    </div>

    <script>
        // State management
        let state = {
            currentSection: 0,
            showResults: false,
            responses: {
                demographics: {},
                personality: {},
                wellbeing: {}
            }
        };

        // Demographics questions
        const demographicsQuestions = [
            { id: 'name', label: 'Nama Penuh', type: 'text', required: true },
            { id: 'ic', label: 'No. MyKad (Tanpa sempang)', type: 'text', required: true, maxLength: 12, pattern: '[0-9]*' },
            { id: 'gender', label: 'Jantina', type: 'select', options: ['Lelaki', 'Perempuan'], required: true },
            { id: 'race', label: 'Bangsa', type: 'select', options: ['Melayu', 'Cina', 'India', 'Bumiputera Sabah/Sarawak', 'Lain-lain'], required: true },
            { id: 'religion', label: 'Agama', type: 'select', options: ['Islam', 'Buddha', 'Kristian', 'Hindu', 'Lain-lain'], required: true },
            { id: 'phone', label: 'No. Telefon (Bimbit)', type: 'text', required: true },
            { 
                id: 'ipgKampus', 
                label: 'Institut Pendidikan Guru Malaysia Kampus', 
                type: 'select', 
                options: [
                    'IPG Kampus Bahasa Melayu',
                    'IPG Kampus Bahasa Antarabangsa',
                    'IPG Kampus Ilmu Khas',
                    'IPG Kampus Pendidikan Islam',
                    'IPG Kampus Pendidikan Teknik',
                    'IPG Kampus Raja Melewar',
                    'IPG Kampus Tun Hussein Onn',
                    'IPG Kampus Temenggong Ibrahim',
                    'IPG Kampus Perempuan Melalyu Melaka',
                    'English Language Teaching Centre (ELTC)',
                    'IPG Kampus Ipoh',
                    'IPG Kampus Pulau Pinang',
                    'IPG Kampus Tuanku Bainun',
                    'IPG Kampus Perlis',
                    'IPG Kampus Darul Aman',
                    'IPG Kampus Sultan Abdul Halim',
                    'IPG Kampus Tengku Ampuan Afzan',
                    'IPG Kampus Dato\' Razali Ismail',
                    'IPG Kampus Sultan Mizan',
                    'IPG Kampus Kota Bharu',
                    'IPG Kampus Kent',
                    'IPG Kampus Gaya',
                    'IPG Kampus Keningau',
                    'IPG Kampus Tawau',
                    'IPG Kampus Batu Lintang',
                    'IPG Kampus Sarawak',
                    'IPG Kampus Rajang',
                    'IPG Kampus Tun Abdul Razak'
                ], 
                required: true 
            }
        ];

        // Personality questions (44 items)
        const personalityQuestions = [
            'Saya melihat diri saya sebagai seorang yang bersikap terbuka',
            'Saya melihat diri saya sebagai seorang yang pemalu, pendiam',
            'Saya melihat diri saya sebagai seorang yang penuh tenaga',
            'Saya melihat diri saya sebagai seorang yang suka bersendirian',
            'Saya melihat diri saya sebagai seorang yang bercakap banyak',
            'Saya melihat diri saya sebagai seorang yang pendiam',
            'Saya melihat diri saya sebagai seorang yang berani',
            'Saya melihat diri saya sebagai seorang yang suka berkumpul',
            'Saya melihat diri saya sebagai seorang yang suka membantu dan tidak mementingkan diri sendiri',
            'Saya melihat diri saya sebagai seorang yang suka mencari kesalahan orang lain',
            'Saya melihat diri saya sebagai seorang yang suka bergaduh',
            'Saya melihat diri saya sebagai seorang yang memaafkan',
            'Saya melihat diri saya sebagai seorang yang percaya kepada orang lain',
            'Saya melihat diri saya sebagai seorang yang boleh menjadi dingin dan tidak peduli',
            'Saya melihat diri saya sebagai seorang yang berhati mulia',
            'Saya melihat diri saya sebagai seorang yang pertimbangkan dan baik kepada orang lain',
            'Saya melihat diri saya sebagai seorang yang suka bekerjasama',
            'Saya melihat diri saya sebagai seorang yang buat kerja dengan teliti',
            'Saya melihat diri saya sebagai seorang yang agak cuai',
            'Saya melihat diri saya sebagai seorang yang boleh dipercayai',
            'Saya melihat diri saya sebagai seorang yang tidak teratur',
            'Saya melihat diri saya sebagai seorang yang berdisiplin diri',
            'Saya melihat diri saya sebagai seorang yang suka melengahkan',
            'Saya melihat diri saya sebagai seorang yang bekerja dengan cekap',
            'Saya melihat diri saya sebagai seorang yang membuat rancangan dan mengikutinya',
            'Saya melihat diri saya sebagai seorang yang mudah teralih perhatian',
            'Saya melihat diri saya sebagai seorang yang tenang dan dapat menangani tekanan',
            'Saya melihat diri saya sebagai seorang yang mudah tertekan',
            'Saya melihat diri saya sebagai seorang yang tidak mudah kecewa',
            'Saya melihat diri saya sebagai seorang yang murung, sedih',
            'Saya melihat diri saya sebagai seorang yang mudah risau',
            'Saya melihat diri saya sebagai seorang yang kadang-kadang berasa tertekan',
            'Saya melihat diri saya sebagai seorang yang mudah marah',
            'Saya melihat diri saya sebagai seorang yang emosi stabil, tidak mudah marah',
            'Saya melihat diri saya sebagai seorang yang inventif',
            'Saya melihat diri saya sebagai seorang yang suka mencuba perkara baru',
            'Saya melihat diri saya sebagai seorang yang mempunyai imaginasi aktif',
            'Saya melihat diri saya sebagai seorang yang suka merenung, bermain dengan idea',
            'Saya melihat diri saya sebagai seorang yang artistik',
            'Saya melihat diri saya sebagai seorang yang suka rutin',
            'Saya melihat diri saya sebagai seorang yang menghargai pengalaman artistik',
            'Saya melihat diri saya sebagai seorang yang konvensional, tradisional',
            'Saya melihat diri saya sebagai seorang yang kreatif',
            'Saya melihat diri saya sebagai seorang yang ingin tahu tentang banyak perkara'
        ];

        // Wellbeing questions (14 items)
        const wellbeingQuestions = [
            'Saya rasa optimistik mengenai masa depan',
            'Saya rasa berguna',
            'Saya rasa tenang',
            'Saya menangani masalah dengan baik',
            'Saya berfikir dengan jelas',
            'Saya rasa dekat dengan orang lain',
            'Saya boleh membuat keputusan sendiri',
            'Saya rasa baik tentang diri saya',
            'Saya berasa yakin',
            'Saya dapat menikmati aktiviti harian saya',
            'Saya boleh membuat keputusan tentang perkara',
            'Saya rasa disayangi',
            'Saya berminat dengan perkara baru',
            'Saya rasa ceria'
        ];

        // Event handlers
        function handleDemographicChange(id, value) {
            if (id === 'ic') {
                const digitsOnly = value.replace(/\D/g, '');
                const limitedDigits = digitsOnly.slice(0, 12);
                state.responses.demographics[id] = limitedDigits;
            } else {
                state.responses.demographics[id] = value;
            }
            saveState();
            // Only update specific elements instead of full re-render for text inputs
            if (id === 'ic') {
                updateICCounter();
            }
        }

        function updateICCounter() {
            const counterElement = document.getElementById('ic-counter');
            if (counterElement && state.responses.demographics.ic) {
                const length = state.responses.demographics.ic.length;
                counterElement.innerHTML = `<span class="${length === 12 ? 'text-green-600' : 'text-red-500'}">(${length}/12)</span>`;
            }
        }

        function handlePersonalityChange(index, value) {
            state.responses.personality[index] = parseInt(value);
            saveState();
            // Don't re-render, just update the visual state
            updateRadioButtonVisual('personality', index, value);
        }

        function handleWellbeingChange(index, value) {
            state.responses.wellbeing[index] = parseInt(value);
            saveState();
            // Don't re-render, just update the visual state
            updateRadioButtonVisual('wellbeing', index, value);
        }

        function updateRadioButtonVisual(section, index, selectedValue) {
            // Update the visual state of radio buttons without re-rendering
            const buttons = document.querySelectorAll(`input[name="${section}-${index}"]`);
            buttons.forEach(button => {
                const container = button.nextElementSibling;
                if (parseInt(button.value) === parseInt(selectedValue)) {
                    if (section === 'personality') {
                        container.className = 'w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium transition-all duration-200 bg-blue-500 text-white shadow-lg transform scale-110';
                    } else {
                        container.className = 'w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium transition-all duration-200 bg-green-500 text-white shadow-lg transform scale-110';
                    }
                } else {
                    container.className = 'w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium transition-all duration-200 bg-gray-200 text-gray-600 hover:bg-gray-300';
                }
            });
        }

        function validateCurrentSection() {
            if (state.currentSection === 0) {
                const requiredFields = ['name', 'ic', 'gender', 'race', 'religion', 'phone', 'ipgKampus'];
                for (let field of requiredFields) {
                    const value = state.responses.demographics[field];
                    if (!value || value.toString().trim() === '') {
                        const fieldNames = {
                            name: 'Nama Penuh',
                            ic: 'No. MyKad',
                            gender: 'Jantina',
                            race: 'Bangsa',
                            religion: 'Agama',
                            phone: 'No. Telefon',
                            ipgKampus: 'IPG Kampus'
                        };
                        return { isValid: false, message: `Sila lengkapkan maklumat ${fieldNames[field]}.` };
                    }
                }
                
                const icNumber = state.responses.demographics.ic || '';
                if (icNumber.length !== 12) {
                    return { isValid: false, message: `No. MyKad mesti mengandungi tepat 12 digit nombor (semasa: ${icNumber.length} digit).` };
                }
            } else if (state.currentSection === 1) {
                for (let i = 0; i < personalityQuestions.length; i++) {
                    if (!state.responses.personality[i]) {
                        return { isValid: false, message: `Sila jawab semua soalan dalam Bahagian B. Soalan ${i + 1} belum dijawab.` };
                    }
                }
            } else if (state.currentSection === 2) {
                for (let i = 0; i < wellbeingQuestions.length; i++) {
                    if (!state.responses.wellbeing[i]) {
                        return { isValid: false, message: `Sila jawab semua soalan dalam Bahagian C. Soalan ${i + 1} belum dijawab.` };
                    }
                }
            }
            return { isValid: true };
        }

        function handleNextSection() {
            const validation = validateCurrentSection();
            if (!validation.isValid) {
                alert(validation.message);
                return;
            }
            state.currentSection++;
            saveState();
            render();
        }

        function handlePrevSection() {
            state.currentSection = Math.max(0, state.currentSection - 1);
            saveState();
            render();
        }

        function calculatePersonalityScores() {
            const { personality } = state.responses;
            
            // Big 5 scoring with proper reverse scoring for BFI-44
            const extraversionItems = [0, 5, 10, 15, 20, 25, 30, 35];
            const extraversionReverse = [5, 15, 25, 35];
            let extraversion = 0;
            extraversionItems.forEach(i => {
                const score = personality[i] || 3;
                extraversion += extraversionReverse.includes(i) ? (6 - score) : score;
            });

            const agreeablenessItems = [1, 6, 11, 16, 21, 26, 31, 36, 41];
            const agreeablenessReverse = [6, 11, 26, 36];
            let agreeableness = 0;
            agreeablenessItems.forEach(i => {
                const score = personality[i] || 3;
                agreeableness += agreeablenessReverse.includes(i) ? (6 - score) : score;
            });

            const conscientiousnessItems = [2, 7, 12, 17, 22, 27, 32, 37, 42];
            const conscientiousnessReverse = [7, 17, 22, 42];
            let conscientiousness = 0;
            conscientiousnessItems.forEach(i => {
                const score = personality[i] || 3;
                conscientiousness += conscientiousnessReverse.includes(i) ? (6 - score) : score;
            });

            const neuroticismItems = [3, 8, 13, 18, 23, 28, 33, 38];
            const neuroticismReverse = [3, 23, 28, 33];
            let neuroticism = 0;
            neuroticismItems.forEach(i => {
                const score = personality[i] || 3;
                neuroticism += neuroticismReverse.includes(i) ? (6 - score) : score;
            });

            const opennessItems = [4, 9, 14, 19, 24, 29, 34, 39, 40, 43];
            const opennessReverse = [9, 24, 34, 39];
            let openness = 0;
            opennessItems.forEach(i => {
                const score = personality[i] || 3;
                openness += opennessReverse.includes(i) ? (6 - score) : score;
            });

            return {
                extraversion: Math.round((extraversion / (8 * 5)) * 100),
                agreeableness: Math.round((agreeableness / (9 * 5)) * 100),
                conscientiousness: Math.round((conscientiousness / (9 * 5)) * 100),
                neuroticism: Math.round((neuroticism / (8 * 5)) * 100),
                openness: Math.round((openness / (10 * 5)) * 100)
            };
        }

        function calculateWellbeingScore() {
            const { wellbeing } = state.responses;
            const totalScore = Object.values(wellbeing).reduce((sum, score) => sum + (score || 1), 0);
            return {
                total: totalScore,
                percentage: Math.round((totalScore / 70) * 100)
            };
        }

        function showResults() {
            const validation = validateCurrentSection();
            if (!validation.isValid) {
                alert(validation.message);
                return;
            }
            
            // Log data for database integration
            const personalityScores = calculatePersonalityScores();
            const wellbeingScore = calculateWellbeingScore();
            
            const formattedData = [
                new Date().toISOString(),
                state.responses.demographics.name || '',
                state.responses.demographics.ic || '',
                state.responses.demographics.gender || '',
                state.responses.demographics.race || '',
                state.responses.demographics.religion || '',
                state.responses.demographics.phone || '',
                state.responses.demographics.ipgKampus || '',
                personalityScores.extraversion || 0,
                personalityScores.agreeableness || 0,
                personalityScores.conscientiousness || 0,
                personalityScores.neuroticism || 0,
                personalityScores.openness || 0,
                ...Array.from({length: 44}, (_, i) => state.responses.personality[i] || 0),
                wellbeingScore.total || 0,
                wellbeingScore.percentage || 0,
                ...Array.from({length: 14}, (_, i) => state.responses.wellbeing[i] || 0)
            ];
            
            console.log('📊 DATA FOR DATABASE:', formattedData);
            console.log('👤 Demographics:', state.responses.demographics);
            console.log('🧠 Personality Scores:', personalityScores);
            console.log('❤️ Wellbeing Score:', wellbeingScore);
            
            state.showResults = true;
            saveState();
            render();
        }

        function generatePDF() {
            const personalityScores = calculatePersonalityScores();
            const wellbeingScore = calculateWellbeingScore();
            const { demographics } = state.responses;

            const reportContent = `LAPORAN PROFIL KESEJAHTERAAN DAN PERSONALITI

=================================================

MAKLUMAT PERIBADI:
Nama: ${demographics.name || 'Tidak dinyatakan'}
No. MyKad: ${demographics.ic || 'Tidak dinyatakan'}
Jantina: ${demographics.gender || 'Tidak dinyatakan'}
Bangsa: ${demographics.race || 'Tidak dinyatakan'}
Agama: ${demographics.religion || 'Tidak dinyatakan'}
No. Telefon: ${demographics.phone || 'Tidak dinyatakan'}
IPG Kampus: ${demographics.ipgKampus || 'Tidak dinyatakan'}

=================================================

KEPUTUSAN PERSONALITI BIG 5:
Extraversion: ${personalityScores.extraversion}%
Agreeableness: ${personalityScores.agreeableness}%
Conscientiousness: ${personalityScores.conscientiousness}%
Neuroticism: ${personalityScores.neuroticism}%
Openness: ${personalityScores.openness}%

=================================================

SKOR KESEJAHTERAAN MENTAL (WEMWBS):
Skor Total: ${wellbeingScore.total}/70
Peratus: ${wellbeingScore.percentage}%

Interpretasi: ${wellbeingScore.percentage >= 70 ? 'Tahap kesejahteraan yang baik' :
               wellbeingScore.percentage >= 50 ? 'Tahap kesejahteraan sederhana' :
               'Mungkin memerlukan perhatian lebih'}

=================================================

Tarikh: ${new Date().toLocaleDateString('ms-MY')}
Masa: ${new Date().toLocaleTimeString('ms-MY')}

=================================================
Institut Pendidikan Guru Malaysia
Profil Kesejahteraan dan Personaliti Warga
=================================================`;

            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Laporan_Personaliti_${demographics.name ? demographics.name.replace(/\s+/g, '_') : 'Tanpa_Nama'}_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function saveState() {
            try {
                localStorage.setItem('questionnaireState', JSON.stringify(state));
            } catch (e) {
                console.warn('Could not save state to localStorage');
            }
        }

        function loadState() {
            try {
                const saved = localStorage.getItem('questionnaireState');
                if (saved) {
                    const parsedState = JSON.parse(saved);
                    state = { ...state, ...parsedState };
                }
            } catch (e) {
                console.warn('Could not load state from localStorage');
            }
        }

        // Render functions
        function renderHeader() {
            return `
                <div class="mb-8 fade-in">
                    <h1 class="text-3xl font-bold text-center text-blue-800 mb-4">
                        Profil Kesejahteraan dan Personaliti Warga
                    </h1>
                    <div class="bg-blue-50 p-4 rounded-lg mb-6">
                        <h3 class="font-bold text-blue-800 mb-2">Pengenalan:</h3>
                        <p class="text-sm text-gray-700 mb-2">
                            Profil Kesejahteraan dan Personaliti Warga terdiri dari tiga bahagian iaitu:
                        </p>
                        <ul class="text-sm text-gray-700 space-y-1 ml-4">
                            <li>• Bahagian A: Maklumat Diri</li>
                            <li>• Bahagian B: Ujian Personaliti (44 ITEM)</li>
                            <li>• Bahagian C: Skala Kesejahteraan Mental Warwick–Edinburgh (14 ITEM)</li>
                        </ul>
                        <p class="text-sm text-gray-700 mt-2">
                            <strong>Komitmen Masa:</strong> Masa yang diambil untuk menjawab inventori ini adalah antara 20 minit.
                        </p>
                    </div>

                    <div class="flex justify-center mb-8">
                        <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200">
                            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-6">
                                ${['Maklumat Diri', 'Ujian Personaliti', 'Kesejahteraan Psikologi'].map((title, index) => `
                                    <div class="flex flex-col items-center px-4 sm:px-6 py-4 rounded-lg transition-all duration-200 ${
                                        state.currentSection === index
                                            ? 'bg-blue-600 text-white shadow-lg'
                                            : state.currentSection > index
                                            ? 'bg-green-500 text-white'
                                            : 'bg-gray-100 text-gray-600'
                                    }">
                                        <div class="text-2xl mb-2">
                                            ${index === 0 ? '👤' : index === 1 ? '🧠' : '❤️'}
                                        </div>
                                        <div class="text-center">
                                            <div class="text-sm font-semibold">Bahagian ${index + 1}</div>
                                            <div class="text-xs font-medium">${title}</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDemographics() {
            return `
                <div class="space-y-6 fade-in">
                    <h2 class="text-2xl font-bold text-blue-800">Bahagian A: Maklumat Diri</h2>
                    <p class="text-gray-600 text-sm">Sila isi maklumat peribadi anda dengan lengkap dan tepat. Maklumat ini adalah sulit.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${demographicsQuestions.map(q => `
                            <div class="space-y-2 ${q.id === 'ipgKampus' ? 'md:col-span-2' : ''}">
                                <label class="block text-sm font-medium text-gray-700">
                                    ${q.label} ${q.required ? '<span class="text-red-500">*</span>' : ''}
                                    ${q.id === 'ic' ? `
                                        <div class="text-xs text-gray-500 mt-1">
                                            <span id="ic-counter" class="${state.responses.demographics.ic && state.responses.demographics.ic.length === 12 ? 'text-green-600' : 'text-red-500'}">
                                                ${state.responses.demographics.ic ? `(${state.responses.demographics.ic.length}/12)` : '(0/12)'}
                                            </span>
                                        </div>
                                    ` : ''}
                                </label>
                                ${q.type === 'select' ? `
                                    <select 
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                        onchange="handleDemographicChange('${q.id}', this.value)"
                                    >
                                        <option value="">${q.id === 'gender' ? 'Pilih jantina' : q.id === 'race' ? 'Pilih bangsa' : q.id === 'religion' ? 'Pilih agama' : q.id === 'ipgKampus' ? 'Pilih kampus' : 'Sila pilih...'}</option>
                                        ${q.options.map(option => `
                                            <option value="${option}" ${state.responses.demographics[q.id] === option ? 'selected' : ''}>${option}</option>
                                        `).join('')}
                                    </select>
                                ` : `
                                    <input 
                                        type="${q.type}"
                                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors"
                                        value="${state.responses.demographics[q.id] || ''}"
                                        placeholder="${q.id === 'ic' ? 'Contoh: 901201081234' : q.id === 'name' ? 'Sila isi nama penuh anda' : q.id === 'phone' ? 'Contoh: 0123456789' : 'Sila isi...'}"
                                        maxlength="${q.maxLength || ''}"
                                        onblur="handleDemographicChange('${q.id}', this.value)"
                                        onkeyup="handleDemographicChange('${q.id}', this.value)"
                                    />
                                `}
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <div class="flex">
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-yellow-800">Privasi Maklumat</h3>
                                <div class="mt-2 text-sm text-yellow-700">
                                    <p>Semua maklumat yang diberikan adalah sulit.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPersonality() {
            return `
                <div class="space-y-6 fade-in">
                    <h2 class="text-2xl font-bold text-blue-800">Bahagian B: Ujian Personaliti (44 Item)</h2>
                    <p class="text-gray-600">Nyatakan sejauh mana anda bersetuju dengan setiap kenyataan berikut:</p>
                    
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <div class="grid grid-cols-1 sm:grid-cols-5 gap-2 text-xs text-gray-700">
                            <span class="text-center">1 = Sangat Tidak Setuju</span>
                            <span class="text-center">2 = Tidak Setuju</span>
                            <span class="text-center">3 = Neutral</span>
                            <span class="text-center">4 = Setuju</span>
                            <span class="text-center">5 = Sangat Setuju</span>
                        </div>
                    </div>

                    <div class="space-y-4">
                        ${personalityQuestions.map((question, index) => `
                            <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                <p class="text-sm text-gray-800 mb-3 leading-relaxed">${index + 1}. ${question}</p>
                                <div class="flex justify-center space-x-3">
                                    ${[1, 2, 3, 4, 5].map(value => `
                                        <label class="cursor-pointer">
                                            <input
                                                type="radio"
                                                name="personality-${index}"
                                                value="${value}"
                                                ${state.responses.personality[index] === value ? 'checked' : ''}
                                                onchange="handlePersonalityChange(${index}, ${value})"
                                                class="sr-only"
                                            />
                                            <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium transition-all duration-200 ${
                                                state.responses.personality[index] === value 
                                                    ? 'bg-blue-500 text-white shadow-lg transform scale-110' 
                                                    : 'bg-gray-200 text-gray-600 hover:bg-gray-300'
                                            }">
                                                ${value}
                                            </div>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderWellbeing() {
            return `
                <div class="space-y-6 fade-in">
                    <h2 class="text-2xl font-bold text-blue-800">Bahagian C: Kesejahteraan Psikologi (14 Item)</h2>
                    <p class="text-gray-600">Fikirkan pengalaman anda dalam <strong>2 minggu yang lalu</strong>. Nyatakan sejauh mana setiap kenyataan menggambarkan pengalaman anda:</p>
                    
                    <div class="bg-green-50 p-4 rounded-lg">
                        <div class="grid grid-cols-1 sm:grid-cols-5 gap-2 text-xs text-gray-700">
                            <span class="text-center">1 = Tiada Masa</span>
                            <span class="text-center">2 = Jarang</span>
                            <span class="text-center">3 = Sesetengah Masa</span>
                            <span class="text-center">4 = Kerap</span>
                            <span class="text-center">5 = Sepanjang Masa</span>
                        </div>
                    </div>

                    <div class="space-y-4">
                        ${wellbeingQuestions.map((question, index) => `
                            <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                <p class="text-sm text-gray-800 mb-3 leading-relaxed">${index + 1}. ${question}</p>
                                <div class="flex justify-center space-x-3">
                                    ${[1, 2, 3, 4, 5].map(value => `
                                        <label class="cursor-pointer">
                                            <input
                                                type="radio"
                                                name="wellbeing-${index}"
                                                value="${value}"
                                                ${state.responses.wellbeing[index] === value ? 'checked' : ''}
                                                onchange="handleWellbeingChange(${index}, ${value})"
                                                class="sr-only"
                                            />
                                            <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium transition-all duration-200 ${
                                                state.responses.wellbeing[index] === value 
                                                    ? 'bg-green-500 text-white shadow-lg transform scale-110' 
                                                    : 'bg-gray-200 text-gray-600 hover:bg-gray-300'
                                            }">
                                                ${value}
                                            </div>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderResults() {
            const personalityScores = calculatePersonalityScores();
            const wellbeingScore = calculateWellbeingScore();

            return `
                <div class="space-y-8 fade-in">
                    <div class="text-center">
                        <h2 class="text-3xl font-bold text-blue-800 mb-2">Keputusan Anda</h2>
                        <p class="text-gray-600">Profil Kesejahteraan dan Personaliti</p>
                        <p class="text-sm text-gray-500 mt-1">Tarikh: ${new Date().toLocaleDateString('ms-MY')}</p>
                    </div>

                    <!-- Demographics Table -->
                    <div class="bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm">
                        <div class="bg-blue-600 text-white px-6 py-3">
                            <h3 class="text-lg font-bold">Maklumat Diri</h3>
                        </div>
                        <div class="p-6">
                            <table class="w-full table-auto">
                                <tbody>
                                    <tr class="border-b border-gray-100">
                                        <td class="py-3 px-3 font-medium text-gray-700 bg-gray-50 w-1/3">Nama Penuh</td>
                                        <td class="py-3 px-3 text-gray-900">${state.responses.demographics.name || 'Tidak dinyatakan'}</td>
                                    </tr>
                                    <tr class="border-b border-gray-100">
                                        <td class="py-3 px-3 font-medium text-gray-700 bg-gray-50">No. MyKad</td>
                                        <td class="py-3 px-3 text-gray-900">${state.responses.demographics.ic || 'Tidak dinyatakan'}</td>
                                    </tr>
                                    <tr class="border-b border-gray-100">
                                        <td class="py-3 px-3 font-medium text-gray-700 bg-gray-50">Jantina</td>
                                        <td class="py-3 px-3 text-gray-900">${state.responses.demographics.gender || 'Tidak dinyatakan'}</td>
                                    </tr>
                                    <tr class="border-b border-gray-100">
                                        <td class="py-3 px-3 font-medium text-gray-700 bg-gray-50">Bangsa</td>
                                        <td class="py-3 px-3 text-gray-900">${state.responses.demographics.race || 'Tidak dinyatakan'}</td>
                                    </tr>
                                    <tr class="border-b border-gray-100">
                                        <td class="py-3 px-3 font-medium text-gray-700 bg-gray-50">Agama</td>
                                        <td class="py-3 px-3 text-gray-900">${state.responses.demographics.religion || 'Tidak dinyatakan'}</td>
                                    </tr>
                                    <tr class="border-b border-gray-100">
                                        <td class="py-3 px-3 font-medium text-gray-700 bg-gray-50">No. Telefon</td>
                                        <td class="py-3 px-3 text-gray-900">${state.responses.demographics.phone || 'Tidak dinyatakan'}</td>
                                    </tr>
                                    <tr>
                                        <td class="py-3 px-3 font-medium text-gray-700 bg-gray-50">IPG Kampus</td>
                                        <td class="py-3 px-3 text-gray-900">${state.responses.demographics.ipgKampus || 'Tidak dinyatakan'}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="grid lg:grid-cols-2 gap-8">
                        <!-- Big 5 Results -->
                        <div class="bg-blue-50 p-6 rounded-lg shadow-sm">
                            <h3 class="text-xl font-bold text-blue-800 mb-6 text-center">Personaliti Big 5</h3>
                            <div class="space-y-4">
                                ${Object.entries(personalityScores).map(([trait, score]) => `
                                    <div class="space-y-2">
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm font-medium capitalize text-gray-700">${trait}</span>
                                            <span class="text-sm font-bold text-blue-600">${score}%</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-3">
                                            <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-3 rounded-full transition-all duration-1000 progress-bar" style="width: ${score}%"></div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="mt-6 p-4 bg-blue-100 rounded-lg">
                                <h4 class="font-semibold text-blue-800 mb-2">Interpretasi Personaliti:</h4>
                                <div class="text-sm text-blue-700 space-y-1">
                                    ${Object.entries(personalityScores).map(([trait, score]) => `
                                        <div><strong>${trait}:</strong> ${score >= 70 ? 'Tinggi' : score >= 30 ? 'Sederhana' : 'Rendah'}</div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>

                        <!-- Mental Wellbeing -->
                        <div class="bg-green-50 p-6 rounded-lg shadow-sm">
                            <h3 class="text-xl font-bold text-green-800 mb-4">Kesejahteraan Mental</h3>
                            <div class="text-center mb-6">
                                <div class="text-5xl font-bold text-green-600 mb-2">${wellbeingScore.total}/70</div>
                                <div class="text-2xl text-gray-600 mb-4">${wellbeingScore.percentage}%</div>
                                <div class="w-full bg-gray-200 rounded-full h-4 mb-4">
                                    <div class="bg-gradient-to-r from-green-500 to-green-600 h-4 rounded-full transition-all duration-1000 progress-bar" style="width: ${wellbeingScore.percentage}%"></div>
                                </div>
                            </div>
                            
                            <div class="p-4 bg-green-100 rounded-lg">
                                <h4 class="font-semibold text-green-800 mb-2">Status Kesejahteraan:</h4>
                                <p class="text-sm text-green-700 font-medium">
                                    ${wellbeingScore.percentage >= 70 ? '✅ Tahap kesejahteraan yang baik' :
                                      wellbeingScore.percentage >= 50 ? '⚠️ Tahap kesejahteraan sederhana' :
                                      '❗ Mungkin memerlukan perhatian lebih'}
                                </p>
                                <div class="mt-3 text-xs text-green-600">
                                    <div>Skor minimum: 14 | Skor maksimum: 70</div>
                                    <div>Skor anda: ${wellbeingScore.total} (${wellbeingScore.percentage}%)</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 no-print">
                        <button
                            onclick="generatePDF()"
                            class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition flex items-center justify-center space-x-2 shadow-md"
                        >
                            <span>📥</span>
                            <span>Muat Turun Laporan</span>
                        </button>
                        <button
                            onclick="window.print()"
                            class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition flex items-center justify-center space-x-2 shadow-md"
                        >
                            <span>🖨️</span>
                            <span>Cetak</span>
                        </button>
                        <button
                            onclick="location.reload()"
                            class="bg-orange-600 text-white px-6 py-3 rounded-lg hover:bg-orange-700 transition flex items-center justify-center space-x-2 shadow-md"
                        >
                            <span>🔄</span>
                            <span>Mulakan Semula</span>
                        </button>
                    </div>

                    <!-- Print-only content -->
                    <div class="print-only mt-8">
                        <div class="text-center border-t-2 border-gray-300 pt-4">
                            <p class="text-sm text-gray-600">Institut Pendidikan Guru Malaysia</p>
                            <p class="text-xs text-gray-500">Profil Kesejahteraan dan Personaliti Warga</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderNavigation() {
            if (state.showResults) return '';
            
            return `
                <div class="flex flex-col sm:flex-row justify-between items-center mt-8 space-y-4 sm:space-y-0">
                    <button
                        onclick="handlePrevSection()"
                        ${state.currentSection === 0 ? 'disabled' : ''}
                        class="flex items-center space-x-2 px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed transition shadow-md w-full sm:w-auto justify-center"
                    >
                        <span>←</span>
                        <span>Sebelumnya</span>
                    </button>

                    <div class="text-sm text-gray-500 text-center">
                        Bahagian ${state.currentSection + 1} daripada 3
                    </div>

                    ${state.currentSection < 2 ? `
                        <button
                            onclick="handleNextSection()"
                            class="flex items-center space-x-2 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition shadow-md w-full sm:w-auto justify-center"
                        >
                            <span>Seterusnya</span>
                            <span>→</span>
                        </button>
                    ` : `
                        <button
                            onclick="showResults()"
                            class="flex items-center space-x-2 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition shadow-md w-full sm:w-auto justify-center"
                        >
                            <span>Lihat Keputusan</span>
                            <span>🎯</span>
                        </button>
                    `}
                </div>
            `;
        }

        function render() {
            let content = '';
            
            if (state.showResults) {
                content = renderResults();
            } else {
                content = renderHeader();
                
                switch (state.currentSection) {
                    case 0:
                        content += renderDemographics();
                        break;
                    case 1:
                        content += renderPersonality();
                        break;
                    case 2:
                        content += renderWellbeing();
                        break;
                }
                
                content += renderNavigation();
            }
            
            document.getElementById('app').innerHTML = content;
            
            // Scroll to top smoothly
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadState();
            render();
            
            // Auto-save every 30 seconds
            setInterval(saveState, 30000);
            
            // Save before page unload
            window.addEventListener('beforeunload', saveState);
        });

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (state.showResults) return;
            
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'ArrowLeft':
                        e.preventDefault();
                        if (state.currentSection > 0) handlePrevSection();
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        if (state.currentSection < 2) {
                            handleNextSection();
                        } else {
                            showResults();
                        }
                        break;
                }
            }
        });
    </script>
</body>
</html>
                                
