<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil Kesejahteraan dan Personaliti Warga</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .progress-bar-animated {
            transition: width 0.5s ease-in-out;
        }
        .radio-container label {
            transition: all 0.2s ease-in-out;
        }
        .radio-container input:checked + label {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .welcome-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .welcome-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="max-w-4xl mx-auto p-4 sm:p-6 bg-white min-h-screen">
        <!-- App content will be rendered here -->
        <div class="text-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-4 text-gray-600">Memuatkan soal selidik...</p>
        </div>
    </div>
    <footer class="text-center py-4 text-sm text-gray-500 bg-white">
        2024@Unit Psikologi dan Kaunseling, IPGM
    </footer>

    <script>
        // --- STATE MANAGEMENT ---
        let state = {
            currentSection: -1, // -1:welcome, 0:demo, 1:personality, 2:wellbeing, 3:resilience
            showResults: false,
            responses: {
                demographics: {},
                personality: {},
                wellbeing: {},
                resilience: {}
            },
            submittedEmails: new Set() // In-memory set to track submitted emails for the session
        };

        // --- QUESTIONNAIRE DATA ---
        const demographicsQuestions = [
            { id: 'name', label: 'Nama Penuh', type: 'text', required: true },
            { id: 'ic', label: 'No. MyKad (Tanpa sempang)', type: 'tel', required: true, maxLength: 12, pattern: '[0-9]*' },
            { id: 'email', label: 'Alamat Email', type: 'email', required: true },
            { id: 'gender', label: 'Jantina', type: 'select', options: ['Lelaki', 'Perempuan'], required: true },
            { id: 'race', label: 'Bangsa', type: 'select', options: ['Melayu', 'Cina', 'India', 'Bumiputera Sabah/Sarawak', 'Lain-lain'], required: true },
            { id: 'religion', label: 'Agama', type: 'select', options: ['Islam', 'Buddha', 'Kristian', 'Hindu', 'Lain-lain'], required: true },
            { id: 'phone', label: 'No. Telefon (Bimbit)', type: 'tel', required: true },
            { id: 'ipgKampus', label: 'IPGM/IPGK', type: 'select', options: ['Institut Pendidikan Guru Malaysia (IPGM)', 'IPG Kampus Bahasa Melayu', 'IPG Kampus Bahasa Antarabangsa', 'IPG Kampus Ilmu Khas', 'IPG Kampus Pendidikan Islam', 'IPG Kampus Pendidikan Teknik', 'IPG Kampus Raja Melewar', 'IPG Kampus Tun Hussein Onn', 'IPG Kampus Temenggong Ibrahim', 'IPG Kampus Perempuan Melayu Melaka', 'IPG Kampus Ipoh', 'IPG Kampus Pulau Pinang', 'IPG Kampus Tuanku Bainun', 'IPG Kampus Perlis', 'IPG Kampus Darul Aman', 'IPG Kampus Sultan Abdul Halim', 'IPG Kampus Tengku Ampuan Afzan', 'IPG Kampus Dato\' Razali Ismail', 'IPG Kampus Sultan Mizan', 'IPG Kampus Kota Bharu', 'IPG Kampus Kent', 'IPG Kampus Gaya', 'IPG Kampus Keningau', 'IPG Kampus Tawau', 'IPG Kampus Batu Lintang', 'IPG Kampus Sarawak', 'IPG Kampus Rajang', 'IPG Kampus Tun Abdul Razak', 'English Language Teaching Centre (ELTC)'], required: true },
            { id: 'jawatan', label: 'Jawatan', type: 'select', options: ['REKTOR', 'TIMBALAN REKTOR KANAN', 'TIMBALAN REKTOR', 'KETUA PENOLONG PENGARAH', 'PENOLONG PENGARAH', 'PENGARAH', 'TIMBALAN PENGARAH', 'KETUA JABATAN', 'KETUA UNIT', 'KETUA KAUNSELOR PENDIDIKAN','PENSYARAH', 'KAUNSELOR PENDIDIKAN', 'PEGAWAI PENGURUSAN', 'PEGAWAI GUNASAMA', 'ANGGOTA KUMPULAN PELAKSANA (AKP)'], required: true },
            { id: 'gred', label: 'Gred', type: 'select', options: ['JUSA B', 'JUSA C', 'DG14', 'DG13', 'DG12', 'DG10', 'DG9', 'F10', 'F9', 'S10', 'S9', 'N2', 'N11', 'H1'], required: true }
        ];

        const personalityQuestions = [
            'Saya seorang yang menceriakan suasana majlis.', 'Saya kurang mengambil berat tentang orang lain.', 'Saya sentiasa bersedia.', 'Saya mudah berasa tertekan.', 'Saya mempunyai kosa kata yang luas.', 'Saya tidak banyak bercakap.', 'Saya cenderung untuk berurusan dengan orang lain.', 'Saya sering meninggalkan barang di merata tempat.', 'Saya tenang pada kebanyakan masa.', 'Saya sukar memahami idea-idea abstrak.', 'Saya berasa selesa dikelilingi orang ramai.', 'Saya sering menghina orang lain.', 'Saya memberikan tumpuan kepada sesuatu perkara secara terperinci.', 'Saya bimbang tentang sesuatu perkara.', 'Saya mempunyai imaginasi yang jelas.', 'Saya suka laksanakan tugas di belakang tabir.', 'Saya simpati dengan perasaan orang lain.', 'Saya sering membuat keadaan menjadi kucar-kacir.', 'Saya jarang berasa sedih.', 'Saya tidak berminat dengan idea-idea abstrak.', 'Saya selalu memulakan perbualan dengan orang lain.', 'Saya tidak berminat dengan masalah orang lain.', 'Saya menyelesaikan tugas dengan segera.', 'Saya mudah terganggu.', 'Saya mempunyai idea-idea yang bernas.', 'Saya kurang bercakap.', 'Saya seorang yang berhati lembut.', 'Saya sering lupa meletakkan kembali barang ke tempat asal.', 'Saya mudah berasa kecewa.', 'Saya tidak mempunyai imaginasi yang baik.', 'Saya selesa berbual dengan ramai orang di sesuatu majlis.', 'Saya tidak berminat berurusan dengan orang lain.', 'Saya suka kepada keteraturan.', 'Hati saya kerap berubah-ubah.', 'Saya cepat memahami sesuatu perkara.', 'Saya tidak suka memberi perhatian kepada diri sendiri.', 'Saya meluangkan masa untuk orang lain.', 'Saya mengelak daripada tanggungjawab.', 'Saya kerap mengalami perubahan emosi.', 'Saya sering menggunakan perkataan yang sukar.', 'Saya tidak kisah menjadi perhatian orang lain.', 'Saya memahami perasaan orang lain.', 'Saya seorang yang mengikut jadual.', 'Saya mudah rasa terganggu.', 'Saya selalu meluangkan masa meneliti sesuatu perkara.', 'Saya akan diam apabila bersama orang yang tidak dikenali.', 'Saya selalu membuat orang lain berasa selesa.', 'Saya teliti dalam kerja saya.', 'Saya sering berasa sedih.', 'Saya seorang yang banyak idea.'
        ];
        
        const wellbeingQuestions = ['Saya rasa optimistik mengenai masa depan', 'Saya rasa diri saya berguna', 'Saya rasa tenang', 'Saya menangani masalah dengan baik', 'Saya berfikir dengan jelas', 'Saya rasa dekat dengan orang lain', 'Saya boleh membuat keputusan sendiri', 'Saya rasa baik tentang diri saya', 'Saya berasa yakin', 'Saya dapat menikmati aktiviti harian saya', 'Saya boleh membuat keputusan terhadap sesuatu perkara', 'Saya rasa disayangi', 'Saya berminat dengan perkara baharu', 'Saya rasa ceria'];

        const resilienceQuestions = [
            'Saya cenderung segera bangkit semula daripada kesukaran.',
            'Saya berasa sukar untuk hadapi situasi yang tertekan.',
            'Saya tidak memerlukan masa yang lama untuk bangkit semula daripada situasi sukar.',
            'Sukar untuk saya bangkit semula setelah berlaku sesuatu yang buruk.',
            'Saya cepat pulih semula apabila menghadapi situasi yang sukar.',
            'Saya cenderung mengambil masa yang panjang untuk pulih daripada kekecewaan dalam hidup saya.'
        ];

        // --- EVENT HANDLERS & STATE UPDATERS ---
        window.startSurvey = function() {
            state.currentSection = 0;
            render();
            window.scrollTo(0, 0);
        }

        window.handleDemographicChange = function(id, value) {
            const inputElement = document.getElementById(id);
            if (id === 'ic' || id === 'phone') {
                let digitsOnly = value.replace(/\D/g, '');
                if (id === 'ic') {
                    digitsOnly = digitsOnly.slice(0, 12);
                    updateICCounter(digitsOnly);
                }
                state.responses.demographics[id] = digitsOnly;
                if (inputElement) {
                    inputElement.value = digitsOnly;
                }
            } else {
                state.responses.demographics[id] = value;
            }
        }

        function updateICCounter(icValue) {
            const counterElement = document.getElementById('ic-counter');
            if (counterElement) {
                const length = icValue.length;
                counterElement.textContent = `(${length}/12)`;
                counterElement.className = `absolute inset-y-0 right-0 pr-3 flex items-center text-sm pointer-events-none font-medium ${length === 12 ? 'text-green-600' : 'text-red-500'}`;
            }
        }

        window.handlePersonalityChange = function(index, value) {
            state.responses.personality[index] = parseInt(value);
            updateRadioButtonVisual('personality', index, value);
        }

        window.handleWellbeingChange = function(index, value) {
            state.responses.wellbeing[index] = parseInt(value);
            updateRadioButtonVisual('wellbeing', index, value);
        }

        window.handleResilienceChange = function(index, value) {
            state.responses.resilience[index] = parseInt(value);
            updateRadioButtonVisual('resilience', index, value);
        }

        function updateRadioButtonVisual(section, index, selectedValue) {
            const buttons = document.querySelectorAll(`input[name="${section}-${index}"]`);
            buttons.forEach(button => {
                const label = button.nextElementSibling;
                const baseClass = 'w-8 h-8 sm:w-10 sm:h-10 rounded-full flex items-center justify-center text-sm font-medium transition-all duration-200 cursor-pointer';
                let specificClass = 'bg-gray-200 text-gray-600 hover:bg-gray-300';
                if (parseInt(button.value) === parseInt(selectedValue)) {
                    let colorClass = 'bg-blue-500'; // Default for personality
                    if (section === 'wellbeing') colorClass = 'bg-green-500';
                    if (section === 'resilience') colorClass = 'bg-indigo-500';
                    specificClass = `${colorClass} text-white shadow-lg transform scale-110`;
                }
                label.className = `${baseClass} ${specificClass}`;
            });
        }

        function validateCurrentSection() {
            if (state.currentSection === 0) {
                for (const field of demographicsQuestions) {
                    if (field.required && !state.responses.demographics[field.id]) {
                        return { isValid: false, message: `Sila lengkapkan maklumat: ${field.label}.` };
                    }
                }
                if ((state.responses.demographics.ic || '').length !== 12) {
                    return { isValid: false, message: `No. MyKad mesti mengandungi tepat 12 digit nombor.` };
                }
                const email = state.responses.demographics.email;
                if (email && state.submittedEmails.has(email.toLowerCase())) {
                    return { isValid: false, message: 'Alamat emel ini telah digunakan untuk menjawab soal selidik. Setiap emel hanya boleh digunakan sekali sahaja.' };
                }
            } else if (state.currentSection === 1) {
                if (Object.keys(state.responses.personality).length < personalityQuestions.length) {
                    return { isValid: false, message: 'Sila jawab semua soalan dalam Bahagian B.' };
                }
            } else if (state.currentSection === 2) {
                if (Object.keys(state.responses.wellbeing).length < wellbeingQuestions.length) {
                    return { isValid: false, message: 'Sila jawab semua soalan dalam Bahagian C.' };
                }
            } else if (state.currentSection === 3) {
                if (Object.keys(state.responses.resilience).length < resilienceQuestions.length) {
                    return { isValid: false, message: 'Sila jawab semua soalan dalam Bahagian D.' };
                }
            }
            return { isValid: true };
        }

        window.handleNextSection = function() {
            const validation = validateCurrentSection();
            if (!validation.isValid) {
                showModal(validation.message);
                return;
            }
            state.currentSection++;
            render();
            window.scrollTo(0, 0);
        }

        window.handlePrevSection = function() {
            state.currentSection = Math.max(0, state.currentSection - 1);
            render();
            window.scrollTo(0, 0);
        }

        // --- SCORE CALCULATIONS ---
        function calculatePersonalityScores() {
            const r = state.responses.personality;
            const p = (index) => r[index - 1] || 3; // Get 1-based index item
            const reverse = (score) => 6 - score;

            const scores = {
                extraversion: p(1) + reverse(p(6)) + p(11) + reverse(p(16)) + p(21) + reverse(p(26)) + p(31) + reverse(p(36)) + p(41) + reverse(p(46)),
                agreeableness: reverse(p(2)) + p(7) + reverse(p(12)) + p(17) + reverse(p(22)) + p(27) + reverse(p(32)) + p(37) + p(42) + p(47),
                conscientiousness: p(3) + reverse(p(8)) + p(13) + reverse(p(18)) + p(23) + reverse(p(28)) + p(33) + reverse(p(38)) + p(43) + p(48),
                neuroticism: p(4) + reverse(p(9)) + p(14) + reverse(p(19)) + p(24) + p(29) + p(34) + p(39) + p(44) + p(49),
                openness: p(5) + reverse(p(10)) + p(15) + reverse(p(20)) + p(25) + reverse(p(30)) + p(35) + p(40) + p(45) + p(50)
            };
            
            const toPercent = (score) => Math.round(((score - 10) / 40) * 100);

            return {
                extraversion: toPercent(scores.extraversion),
                agreeableness: toPercent(scores.agreeableness),
                conscientiousness: toPercent(scores.conscientiousness),
                neuroticism: toPercent(scores.neuroticism),
                openness: toPercent(scores.openness)
            };
        }

        function calculateWellbeingScore() {
            const totalScore = Object.values(state.responses.wellbeing).reduce((sum, score) => sum + (score || 0), 0);
            return { total: totalScore };
        }

        function calculateResilienceScore() {
            const r = state.responses.resilience;
            const reverseScore = (score) => 6 - score;
            const scores = [
                r[0], reverseScore(r[1]), r[2], reverseScore(r[3]), r[4], reverseScore(r[5])
            ];
            const totalScore = scores.reduce((sum, score) => sum + (score || 3), 0);
            const meanScore = totalScore / resilienceQuestions.length;
            return { mean: parseFloat(meanScore.toFixed(2)) };
        }

        // --- DATA SUBMISSION ---
        async function sendToGoogleSheets(data) {
            const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbzbutt0Oeg7211Bl8oXspkQlxUZBhcaH5Xpg5tJ9WWp8XV2y5UuSEr4bjoAu_laiBmYnA/exec';
            try {
                await fetch(GOOGLE_SHEETS_URL, {
                    method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                console.log('✅ Data submission attempted. Check Google Sheets for result.');
            } catch (error) {
                console.error('❌ Error sending data to Google Sheets:', error);
                showModal("Maaf, terdapat ralat semasa menghantar data anda. Sila cuba lagi.");
            }
        }
        
        window.showResults = function() {
            const validation = validateCurrentSection();
            if (!validation.isValid) {
                showModal(validation.message);
                return;
            }

            const email = state.responses.demographics.email;
            if (email) {
                state.submittedEmails.add(email.toLowerCase());
            }

            const personalityScores = calculatePersonalityScores();
            const wellbeingScore = calculateWellbeingScore();
            const resilienceScore = calculateResilienceScore();
            const getTahap = (score) => (score >= 67 ? 'Tinggi' : score >= 34 ? 'Sederhana' : 'Rendah');
            const tahapKesejahteraan = wellbeingScore.total >= 45 ? "Tinggi" : wellbeingScore.total >= 25 ? "Sederhana" : "Rendah";
            const tahapDayaTahan = resilienceScore.mean > 4.3 ? 'Tinggi' : resilienceScore.mean >= 3 ? 'Normal' : 'Rendah';
            const personalityRanked = Object.entries(personalityScores).sort(([, a], [, b]) => b - a).map(([key]) => key);

            const sheetData = {
                timestamp: new Date().toLocaleString('en-GB', { timeZone: 'Asia/Kuala_Lumpur' }),
                ...state.responses.demographics,
                mykad: `'${state.responses.demographics.ic || ''}`,
                ...personalityScores,
                tahap_extraversion: getTahap(personalityScores.extraversion),
                tahap_agreeableness: getTahap(personalityScores.agreeableness),
                tahap_conscientiousness: getTahap(personalityScores.conscientiousness),
                tahap_neuroticism: getTahap(personalityScores.neuroticism),
                tahap_openness: getTahap(personalityScores.openness),
                domain_1: personalityRanked[0] || '', domain_2: personalityRanked[1] || '', domain_3: personalityRanked[2] || '',
                ...Object.fromEntries(Array.from({length: 50}, (_, i) => [`p${i+1}`, state.responses.personality[i] || 0])),
                wellbeingTotal: wellbeingScore.total,
                tahap_kesejahteraan: tahapKesejahteraan,
                ...Object.fromEntries(Array.from({length: 14}, (_, i) => [`w${i+1}`, state.responses.wellbeing[i] || 0])),
                resilienceMean: resilienceScore.mean,
                tahap_daya_tahan: tahapDayaTahan,
                ...Object.fromEntries(Array.from({length: 6}, (_, i) => [`d${i+1}`, state.responses.resilience[i] || 0]))
            };

            sendToGoogleSheets(sheetData);
            
            state.showResults = true;
            render();
            window.scrollTo(0, 0);
        }

        // --- PDF GENERATION ---
        window.generatePDF = async function() {
            const pdfButton = document.getElementById('pdf-button');
            pdfButton.disabled = true;
            pdfButton.innerHTML = `<div class="flex items-center justify-center"><svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Menjana PDF...</div>`;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });
            const personalityScores = calculatePersonalityScores();
            const wellbeingScore = calculateWellbeingScore();
            const resilienceScore = calculateResilienceScore();
            const demographics = state.responses.demographics;
            
            const getTahap = (score) => (score >= 67 ? 'Tinggi' : score >= 34 ? 'Sederhana' : 'Rendah');
            const getWellbeingTahap = (total) => (total >= 45 ? "Tinggi" : total >= 25 ? "Sederhana" : "Rendah");
            const getResilienceTahap = (mean) => (mean > 4.3 ? 'Tinggi' : mean >= 3.0 ? 'Normal' : 'Rendah');

            const getTahapStyle = (tahap) => {
                if (tahap === 'Tinggi') return { color: [0, 150, 0] };
                if (tahap === 'Sederhana' || tahap === 'Normal') return { color: [255, 165, 0] };
                return { color: [255, 0, 0] };
            };
            
            const interpretations = {
                wellbeing: {
                    Tinggi: "Tahap kesejahteraan yang tinggi menunjukkan anda mempunyai pandangan hidup yang positif, berasa yakin, dan mempunyai hubungan yang baik dengan orang lain. Anda berkemungkinan besar dapat menangani tekanan hidup seharian dengan berkesan.",
                    Sederhana: "Tahap kesejahteraan yang sederhana menunjukkan anda secara amnya berada dalam keadaan yang baik, tetapi mungkin terdapat beberapa aspek dalam hidup anda yang boleh ditambah baik untuk meningkatkan kepuasan dan kebahagiaan.",
                    Rendah: "Tahap kesejahteraan yang rendah mungkin menunjukkan anda sedang berhadapan dengan cabaran atau tekanan. Adalah penting untuk memberi perhatian kepada kesihatan mental anda dan mungkin mendapatkan sokongan daripada kaunselor atau orang yang dipercayai."
                },
                resilience: {
                    Tinggi: "Daya tahan yang tinggi menunjukkan anda mempunyai keupayaan yang sangat baik untuk bangkit semula daripada kesukaran, tekanan, dan cabaran. Anda cenderung untuk melihat kesukaran sebagai peluang untuk berkembang.",
                    Normal: "Anda mempunyai tahap daya tahan yang normal. Ini bermakna anda mampu menghadapi kebanyakan cabaran hidup, walaupun kadangkala anda mungkin memerlukan sedikit masa untuk pulih daripada peristiwa yang sangat tertekan.",
                    Rendah: "Daya tahan yang rendah mungkin bermakna anda merasa sukar untuk pulih selepas menghadapi cabaran atau kekecewaan. Membina strategi daya tahan boleh membantu anda menguruskan tekanan dengan lebih baik pada masa hadapan."
                },
                personality: {
                    extraversion: { label: 'Extraversion', description: 'Tahap di mana seseorang itu suka bersosial, bertenaga dan mempunyai emosi positif. Skor tinggi menunjukkan anda seorang yang peramah dan aktif, manakala skor rendah menunjukkan anda lebih suka bersendirian dan pendiam.' },
                    agreeableness: { label: 'Agreeableness', description: 'Kecenderungan untuk bersimpati dan bekerjasama. Skor tinggi menunjukkan anda seorang yang mudah mesra dan baik hati, manakala skor rendah menunjukkan anda seorang yang lebih kompetitif dan analitikal.' },
                    conscientiousness: { label: 'Conscientiousness', description: 'Kecenderungan untuk berdisiplin, teratur dan bermatlamat. Skor tinggi menunjukkan anda seorang yang berhati-hati dan boleh dipercayai, manakala skor rendah menunjukkan anda lebih spontan dan fleksibel.' },
                    neuroticism: { label: 'Neuroticism', description: 'Kecenderungan untuk mengalami emosi negatif seperti marah, cemas atau tertekan. Skor tinggi menunjukkan anda lebih reaktif dari segi emosi dan mudah risau, manakala skor rendah menunjukkan anda seorang yang tenang dan stabil.' },
                    openness: { label: 'Openness', description: 'Kecenderungan untuk menghargai seni, emosi, pengembaraan, dan idea luar biasa. Skor tinggi menunjukkan anda seorang yang kreatif dan ingin tahu, manakala skor rendah menunjukkan anda lebih praktikal dan konvensional.' }
                }
            };

            const margin = 40;
            const pageWidth = doc.internal.pageSize.getWidth();
            let y = margin;

            // --- PAGE 1 ---
            doc.setFont('helvetica', 'bold').setFontSize(18).text('Laporan Profil Individu', pageWidth / 2, y, { align: 'center' });
            y += 25;
            
            doc.setFont('helvetica', 'bold').setFontSize(12).text('Maklumat Demografi', margin, y);
            y += 15;
            doc.setFont('helvetica', 'normal').setFontSize(10);
            doc.text(`Nama: ${demographics.name || ''}`, margin, y);
            doc.text(`Emel: ${demographics.email || ''}`, margin + 250, y);
            y += 15;
            doc.text(`No. MyKad: ${demographics.ic || ''}`, margin, y);
            doc.text(`No. Telefon: ${demographics.phone || ''}`, margin + 250, y);
            y += 15;
            doc.text(`Jantina: ${demographics.gender || ''}`, margin, y);
            doc.text(`IPGK: ${demographics.ipgKampus || ''}`, margin + 250, y);
            y += 15;
            doc.text(`Jawatan: ${demographics.jawatan || ''}`, margin, y);
            doc.text(`Gred: ${demographics.gred || ''}`, margin + 250, y);
            y += 30;

            const boxWidth = (pageWidth - margin * 2 - 20) / 2;
            const boxHeight = 80;
            
            const wellbeingTahapText = getWellbeingTahap(wellbeingScore.total);
            const resilienceTahapText = getResilienceTahap(resilienceScore.mean);

            doc.setFillColor(249, 250, 251).roundedRect(margin, y, boxWidth, boxHeight, 10, 10, 'F');
            doc.setFontSize(12).setFont('helvetica', 'bold').text('Kesejahteraan Psikologi', margin + boxWidth/2, y + 20, { align: 'center' });
            doc.setFontSize(24).setFont('helvetica', 'bold').setTextColor(...getTahapStyle(wellbeingTahapText).color).text(String(wellbeingScore.total), margin + boxWidth/2, y + 50, { align: 'center' });
            doc.setFontSize(10).setFont('helvetica', 'normal').setTextColor(0,0,0).text(`Tahap: ${wellbeingTahapText}`, margin + boxWidth/2, y + 65, { align: 'center' });

            doc.setFillColor(249, 250, 251).roundedRect(margin + boxWidth + 20, y, boxWidth, boxHeight, 10, 10, 'F');
            doc.setFontSize(12).setFont('helvetica', 'bold').text('Daya Tahan (Resilience)', margin + boxWidth + 20 + boxWidth/2, y + 20, { align: 'center' });
            doc.setFontSize(24).setFont('helvetica', 'bold').setTextColor(...getTahapStyle(resilienceTahapText).color).text(String(resilienceScore.mean), margin + boxWidth + 20 + boxWidth/2, y + 50, { align: 'center' });
            doc.setFontSize(10).setFont('helvetica', 'normal').setTextColor(0,0,0).text(`Tahap: ${resilienceTahapText}`, margin + boxWidth + 20 + boxWidth/2, y + 65, { align: 'center' });
            y += boxHeight + 25;

            const chartCanvas = document.getElementById('personalityChart');
            const chartImage = chartCanvas.toDataURL('image/png', 1.0);
            const chartWidth = 280;
            doc.addImage(chartImage, 'PNG', (pageWidth - chartWidth) / 2, y, chartWidth, chartWidth);
            
            // --- PAGE 2 ---
            doc.addPage();
            y = margin;

            doc.setFontSize(14).setFont('helvetica', 'bold').text('Skor & Interpretasi', margin, y);
            y += 25;

            // Wellbeing Interpretation
            doc.setFontSize(11).setFont('helvetica', 'bold').text('Interpretasi Kesejahteraan Psikologi', margin, y);
            y += 12;
            doc.setFontSize(10).setFont('helvetica', 'normal');
            let lines = doc.splitTextToSize(interpretations.wellbeing[wellbeingTahapText], pageWidth - margin * 2);
            doc.text(lines, margin, y);
            y += lines.length * 12 + 15;

            // Resilience Interpretation
            doc.setFontSize(11).setFont('helvetica', 'bold').text('Interpretasi Daya Tahan (Resilience)', margin, y);
            y += 12;
            doc.setFontSize(10).setFont('helvetica', 'normal');
            lines = doc.splitTextToSize(interpretations.resilience[resilienceTahapText], pageWidth - margin * 2);
            doc.text(lines, margin, y);
            y += lines.length * 12 + 25;

            // Personality Table
            doc.setFontSize(11).setFont('helvetica', 'bold').text('Skor Personaliti (Big Five)', margin, y);
            y += 15;
            doc.setFontSize(10).setFont('helvetica', 'bold');
            doc.text('Domain', margin + 10, y);
            doc.text('Skor (%)', margin + 250, y);
            doc.text('Tahap', margin + 400, y);
            y += 5;
            doc.setLineWidth(0.5).line(margin, y, pageWidth - margin, y);
            y += 15;

            doc.setFont('helvetica', 'normal');
            Object.entries(personalityScores).forEach(([key, score]) => {
                const trait = interpretations.personality[key];
                const tahapText = getTahap(score);
                const style = getTahapStyle(tahapText);
                doc.text(trait.label, margin + 10, y);
                doc.text(String(score), margin + 250, y);
                doc.setTextColor(...style.color).text(tahapText, margin + 400, y).setTextColor(0,0,0);
                y += 20;
            });
            y += 15;
            
            doc.setFont('helvetica', 'italic').setFontSize(10);
            const counselorNote = "Untuk mendapatkan penerangan yang lebih mendalam tentang PKPW, sila berjumpa Kaunselor Pendidikan Institut di kampus masing-masing.";
            const noteLines = doc.splitTextToSize(counselorNote, pageWidth - margin * 2);
            if (y + (noteLines.length * 12) > doc.internal.pageSize.getHeight() - 100) { // Check if space is enough for note and signature
                doc.addPage();
                y = margin;
            }
            y += 15;
            doc.text(noteLines, margin, y);
            y += (noteLines.length * 12) + 60;

            // Signature Space
            doc.setLineWidth(0.5).line(margin, y, margin + 200, y);
            y += 12;
            doc.setFont('helvetica', 'normal').setFontSize(10);
            doc.text('(Kaunselor Pendidikan Institut)', margin, y);

            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8).setTextColor(150).text(`2024@Unit Psikologi dan Kaunseling, IPGM | Muka surat ${i} dari ${pageCount}`, pageWidth / 2, doc.internal.pageSize.getHeight() - 15, { align: 'center' });
            }

            const fileName = `Profil_Kesejahteraan_${demographics.name.replace(/ /g, '_') || 'Pengguna'}.pdf`;
            doc.save(fileName);
            pdfButton.disabled = false;
            pdfButton.innerHTML = 'Muat Turun Laporan PDF';
        }
        
        // --- UI RENDERING ---
        function render() {
            const app = document.getElementById('app');
            app.className = "max-w-4xl mx-auto p-4 sm:p-6 bg-white min-h-screen shadow-lg rounded-lg border border-gray-200 fade-in";
            
            if (state.currentSection === -1) {
                app.innerHTML = renderWelcomePage();
            } else if (state.showResults) {
                app.innerHTML = renderResults();
                setTimeout(renderSpiderChart, 50);
            } else {
                const totalSections = 4;
                const progress = ((state.currentSection + 1) / totalSections) * 100;
                let content = '';
                if (state.currentSection === 0) content = renderDemographics();
                else if (state.currentSection === 1) content = renderPersonality();
                else if (state.currentSection === 2) content = renderWellbeing();
                else if (state.currentSection === 3) content = renderResilience();

                app.innerHTML = `
                    <div class="mb-6">
                        <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 text-center">Profil Kesejahteraan dan Personaliti Warga IPG</h1>
                        <p class="text-center text-gray-500 mt-2">Unit Psikologi dan Kaunseling, IPGM</p>
                        <div class="mt-6">
                            <div class="bg-gray-200 rounded-full h-2.5">
                                <div class="bg-blue-600 h-2.5 rounded-full progress-bar-animated" style="width: ${progress}%"></div>
                            </div>
                            <p class="text-sm text-right text-gray-600 mt-1">Bahagian ${state.currentSection + 1} dari ${totalSections}</p>
                        </div>
                    </div>
                    ${content}
                `;
                 if(state.currentSection === 0) {
                     updateICCounter(state.responses.demographics.ic || '');
                 }
            }
        }

        function renderWelcomePage() {
            return `
                <div class="text-center py-10 px-4 fade-in">
                    <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Selamat Datang</h1>
                    <p class="mt-4 text-lg text-gray-600 max-w-2xl mx-auto">Profil Kesejahteraan dan Personaliti Warga (PKPW) adalah ujian bagi mengenalpasti tahap kesejahteraan psikologi, tret personaliti dan daya tahan warga kerja di IPGM.</p>
                    <p class="mt-2 text-lg text-gray-600 max-w-2xl mx-auto font-bold">Komitmen masa untuk menjawab adalah sekitar 20-25 minit.</p>
                    
                    <div class="mt-12">
                        <h2 class="text-2xl font-semibold text-gray-700 mb-8">Tinjauan Soal Selidik</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 max-w-4xl mx-auto">
                            <div class="welcome-card bg-white p-6 rounded-lg border border-gray-200 shadow-md">
                                <div class="flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 text-blue-600 mx-auto mb-4"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg></div>
                                <h3 class="text-lg font-bold text-gray-800">Bahagian A</h3><p class="text-gray-600 font-semibold">Maklumat Diri</p>
                            </div>
                            <div class="welcome-card bg-white p-6 rounded-lg border border-gray-200 shadow-md">
                                <div class="flex items-center justify-center h-12 w-12 rounded-full bg-purple-100 text-purple-600 mx-auto mb-4"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg></div>
                                <h3 class="text-lg font-bold text-gray-800">Bahagian B</h3><p class="text-gray-600 font-semibold">Personaliti Diri</p>
                            </div>
                            <div class="welcome-card bg-white p-6 rounded-lg border border-gray-200 shadow-md">
                                <div class="flex items-center justify-center h-12 w-12 rounded-full bg-green-100 text-green-600 mx-auto mb-4"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg></div>
                                <h3 class="text-lg font-bold text-gray-800">Bahagian C</h3><p class="text-gray-600 font-semibold">Kesejahteraan</p>
                            </div>
                            <div class="welcome-card bg-white p-6 rounded-lg border border-gray-200 shadow-md">
                                <div class="flex items-center justify-center h-12 w-12 rounded-full bg-indigo-100 text-indigo-600 mx-auto mb-4"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 15.75l-2.4-2.4m0 0l2.4-2.4m-2.4 2.4h10.125M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                                <h3 class="text-lg font-bold text-gray-800">Bahagian D</h3><p class="text-gray-600 font-semibold">Daya Tahan</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-12">
                        <button onclick="startSurvey()" class="bg-blue-600 text-white font-bold py-3 px-10 rounded-lg hover:bg-blue-700 transition-colors text-lg shadow-lg hover:shadow-xl">Mula Soal Selidik</button>
                    </div>
                </div>
            `;
        }

        function renderDemographics() {
            const fieldsHtml = demographicsQuestions.map(q => {
                const value = state.responses.demographics[q.id] || '';
                let inputHtml;
                switch (q.type) {
                    case 'select':
                        inputHtml = `<select id="${q.id}" onchange="handleDemographicChange('${q.id}', this.value)" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm" ${q.required ? 'required' : ''}>
                                <option value="" disabled ${!value ? 'selected' : ''}>Sila pilih...</option>
                                ${q.options.map(opt => `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                            </select>`;
                        break;
                    default:
                        inputHtml = `<div class="relative rounded-md shadow-sm">
                                <input type="${q.type}" id="${q.id}" value="${value}" oninput="handleDemographicChange('${q.id}', this.value)" class="block w-full pl-3 pr-12 py-2 border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 sm:text-sm" ${q.required ? 'required' : ''} ${q.maxLength ? `maxlength="${q.maxLength}"` : ''} ${q.pattern ? `pattern="${q.pattern}"` : ''}>
                                ${q.id === 'ic' ? `<div id="ic-counter" class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm text-gray-500 pointer-events-none"></div>` : ''}
                            </div>`;
                        break;
                }
                return `<div>
                        <label for="${q.id}" class="block text-sm font-medium text-gray-700">${q.label}${q.required ? '<span class="text-red-500">*</span>' : ''}</label>
                        ${inputHtml}
                    </div>`;
            }).join('');
            const nextButtonHtml = `<button onclick="handleNextSection()" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">Seterusnya &rarr;</button>`;

            return `<div class="space-y-6">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-2">Bahagian A: Maklumat Diri</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">${fieldsHtml}</div>
                    <div class="flex justify-end pt-4">${nextButtonHtml}</div>
                </div>`;
        }
        
        function renderQuestionnaireSection(title, questions, handleChange, sectionName, scaleLabels, scaleDescription) {
            const questionsHtml = questions.map((q, index) => {
                const selectedValue = state.responses[sectionName][index];
                const radioButtons = [1, 2, 3, 4, 5].map(value => {
                    const isChecked = selectedValue === value;
                    let colorClass = 'bg-blue-500'; // Default
                    if (sectionName === 'wellbeing') colorClass = 'bg-green-500';
                    if (sectionName === 'resilience') colorClass = 'bg-indigo-500';
                    return `<div class="radio-container">
                            <input type="radio" id="${sectionName}-${index}-${value}" name="${sectionName}-${index}" value="${value}" class="hidden" onchange="${handleChange}(${index}, this.value)" ${isChecked ? 'checked' : ''}>
                            <label for="${sectionName}-${index}-${value}" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full flex items-center justify-center text-sm font-medium transition-all duration-200 cursor-pointer ${isChecked ? `${colorClass} text-white shadow-lg transform scale-110` : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}">${value}</label>
                        </div>`;
                }).join('');

                return `<div class="p-4 rounded-lg border bg-gray-50 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                        <p class="font-medium text-gray-800 flex-1"><span class="font-bold">${index + 1}.</span> ${q}</p>
                        <div class="flex items-center space-x-2 sm:space-x-3">${radioButtons}</div>
                    </div>`;
            }).join('');

            return `<div class="space-y-6">
                    <h2 class="text-xl font-semibold text-gray-800 border-b pb-2">${title}</h2>
                    <div class="bg-blue-50 p-4 rounded-lg text-blue-800">
                        <p class="font-semibold">Arahan:</p>
                        <p>${scaleDescription}</p>
                        <div class="flex justify-between text-xs sm:text-sm font-medium mt-2 px-1">
                            <span>1: ${scaleLabels['1']}</span>
                            <span>2: ${scaleLabels['2']}</span>
                            <span>3: ${scaleLabels['3']}</span>
                            <span>4: ${scaleLabels['4']}</span>
                            <span>5: ${scaleLabels['5']}</span>
                        </div>
                    </div>
                    <div class="space-y-4">${questionsHtml}</div>
                    <div class="flex justify-between pt-4">
                        <button onclick="handlePrevSection()" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition-colors">&larr; Kembali</button>
                        ${state.currentSection === 3 
                            ? `<button onclick="showResults()" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition-colors">Lihat Keputusan</button>` 
                            : `<button onclick="handleNextSection()" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">Seterusnya &rarr;</button>`
                        }
                    </div>
                </div>`;
        }

        function renderPersonality() {
            return renderQuestionnaireSection('Bahagian B: Personaliti Diri (Big Five Inventory)', personalityQuestions, 'handlePersonalityChange', 'personality', {
                '1': 'Sangat Tidak Setuju',
                '2': 'Tidak Setuju',
                '3': 'Sederhana',
                '4': 'Setuju',
                '5': 'Sangat Setuju'
            }, 'Sila tandakan pada skala yang paling sesuai untuk menggambarkan diri anda.');
        }

        function renderWellbeing() {
            return renderQuestionnaireSection('Bahagian C: Kesejahteraan Psikologi (WEMWBS)', wellbeingQuestions, 'handleWellbeingChange', 'wellbeing', {
                '1': 'Sangat Jarang / Tidak Pernah',
                '2': 'Jarang',
                '3': 'Kadang-kadang',
                '4': 'Kerap',
                '5': 'Sangat Kerap / Sentiasa'
            }, 'Berikut adalah kenyataan mengenai perasaan dan pemikiran anda. Sila tandakan jawapan yang paling menggambarkan pengalaman anda sepanjang 2 minggu yang lalu.');
        }

        function renderResilience() {
            return renderQuestionnaireSection('Bahagian D: Daya Tahan', resilienceQuestions, 'handleResilienceChange', 'resilience', {
                '1': 'Sangat Tidak Setuju',
                '2': 'Tidak Setuju',
                '3': 'Sederhana',
                '4': 'Setuju',
                '5': 'Sangat Setuju'
            }, 'Sila tandakan pada nombor yang disediakan mengikut kecenderungan anda. Secara jujurnya, bagaimana penilaian terhadap diri anda kepada situasi tekanan tersebut?');
        }

        function renderResults() {
             const { name } = state.responses.demographics;
             const personalityScores = calculatePersonalityScores();
             const wellbeingScore = calculateWellbeingScore();
             const resilienceScore = calculateResilienceScore();

             const getTahapStyle = (score) => {
                if (score >= 67) return { text: 'Tinggi', color: 'text-green-600', bg: 'bg-green-100' };
                if (score >= 34) return { text: 'Sederhana', color: 'text-yellow-600', bg: 'bg-yellow-100' };
                return { text: 'Rendah', color: 'text-red-600', bg: 'bg-red-100' };
             };
             const getWellbeingTahapStyle = (total) => {
                if (total >= 45) return { text: 'Tinggi', color: 'text-green-600', bg: 'bg-green-100' };
                if (total >= 25) return { text: 'Sederhana', color: 'text-yellow-600', bg: 'bg-yellow-100' };
                return { text: 'Rendah', color: 'text-red-600', bg: 'bg-red-100' };
             };
             const getResilienceTahapStyle = (mean) => {
                if (mean > 4.3) return { text: 'Tinggi', color: 'text-green-600', bg: 'bg-green-100' };
                if (mean >= 3.0) return { text: 'Normal', color: 'text-yellow-600', bg: 'bg-yellow-100' };
                return { text: 'Rendah', color: 'text-red-600', bg: 'bg-red-100' };
             };

             const personalityTraits = {
                extraversion: { label: 'Extraversion', description: 'Tahap di mana seseorang itu suka bersosial, bertenaga dan mempunyai emosi positif. Skor tinggi menunjukkan anda seorang yang peramah dan aktif, manakala skor rendah menunjukkan anda lebih suka bersendirian dan pendiam.' },
                agreeableness: { label: 'Agreeableness', description: 'Kecenderungan untuk bersimpati dan bekerjasama. Skor tinggi menunjukkan anda seorang yang mudah mesra dan baik hati, manakala skor rendah menunjukkan anda seorang yang lebih kompetitif dan analitikal.' },
                conscientiousness: { label: 'Conscientiousness', description: 'Kecenderungan untuk berdisiplin, teratur dan bermatlamat. Skor tinggi menunjukkan anda seorang yang berhati-hati dan boleh dipercayai, manakala skor rendah menunjukkan anda lebih spontan dan fleksibel.' },
                neuroticism: { label: 'Neuroticism', description: 'Kecenderungan untuk mengalami emosi negatif seperti marah, cemas atau tertekan. Skor tinggi menunjukkan anda lebih reaktif dari segi emosi dan mudah risau, manakala skor rendah menunjukkan anda seorang yang tenang dan stabil.' },
                openness: { label: 'Openness', description: 'Kecenderungan untuk menghargai seni, emosi, pengembaraan, dan idea luar biasa. Skor tinggi menunjukkan anda seorang yang kreatif dan ingin tahu, manakala skor rendah menunjukkan anda lebih praktikal dan konvensional.' }
             };
             
            const personalityRanked = Object.entries(personalityScores).sort(([,a],[,b]) => b-a).map(([key]) => key);
            const wellbeingTahap = getWellbeingTahapStyle(wellbeingScore.total);
            const resilienceTahap = getResilienceTahapStyle(resilienceScore.mean);

             return `<div id="results-content" class="space-y-8 p-2 sm:p-4">
                    <div class="text-center border-b pb-6">
                        <h1 class="text-3xl font-bold text-gray-800">Laporan Profil Individu</h1>
                        <p class="text-xl text-gray-600 mt-2">${name || 'Pengguna'}</p>
                    </div>

                    <div class="grid md:grid-cols-2 gap-8">
                        <div class="bg-gray-50 p-6 rounded-lg shadow-sm">
                            <h2 class="text-2xl font-bold text-center text-gray-800 mb-4">Kesejahteraan Psikologi</h2>
                            <div class="text-center">
                                <p class="text-lg text-gray-600">Skor WEMWBS:</p>
                                <p class="text-5xl font-bold text-green-600 my-2">${wellbeingScore.total}</p>
                                <div class="inline-flex items-center px-4 py-1 rounded-full text-lg font-semibold ${wellbeingTahap.bg} ${wellbeingTahap.color}">${wellbeingTahap.text}</div>
                            </div>
                        </div>
                        <div class="bg-gray-50 p-6 rounded-lg shadow-sm">
                            <h2 class="text-2xl font-bold text-center text-gray-800 mb-4">Daya Tahan (Resilience)</h2>
                            <div class="text-center">
                                <p class="text-lg text-gray-600">Skor Purata BRS:</p>
                                <p class="text-5xl font-bold text-indigo-600 my-2">${resilienceScore.mean}</p>
                                <div class="inline-flex items-center px-4 py-1 rounded-full text-lg font-semibold ${resilienceTahap.bg} ${resilienceTahap.color}">${resilienceTahap.text}</div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-50 p-6 rounded-lg shadow-sm">
                        <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Profil Personaliti (Big Five)</h2>
                        <div class="grid lg:grid-cols-2 gap-8 items-center">
                            <div><canvas id="personalityChart"></canvas></div>
                            <div class="space-y-4">
                                ${Object.entries(personalityScores).map(([key, score]) => {
                                    const style = getTahapStyle(score);
                                    return `<div class="flex items-center justify-between p-3 bg-white rounded-md border">
                                        <div class="flex items-center"><span class="font-semibold text-gray-700">${personalityTraits[key].label}</span></div>
                                        <div class="text-right"><span class="font-bold text-lg text-blue-600">${score}%</span><span class="block text-xs font-medium px-2 py-0.5 rounded-full ${style.bg} ${style.color}">${style.text}</span></div>
                                    </div>`
                                }).join('')}
                            </div>
                        </div>
                    </div>
                    <div>
                         <h2 class="text-2xl font-bold text-center text-gray-800 my-6">Interpretasi Personaliti Anda</h2>
                         <div class="space-y-4">
                             <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                <h3 class="font-bold text-lg text-blue-800">Domain Personaliti Paling Dominan Anda:</h3>
                                <ol class="list-decimal list-inside mt-2 text-blue-700 space-y-1">
                                    <li><span class="font-semibold">${personalityTraits[personalityRanked[0]].label}</span></li>
                                    <li><span class="font-semibold">${personalityTraits[personalityRanked[1]].label}</span></li>
                                    <li><span class="font-semibold">${personalityTraits[personalityRanked[2]].label}</span></li>
                                </ol>
                            </div>
                             ${Object.keys(personalityTraits).map(key => `
                                 <div class="p-4 bg-white border rounded-lg">
                                     <h3 class="font-bold text-lg text-gray-800">${personalityTraits[key].label}</h3>
                                     <p class="mt-1 text-gray-600">${personalityTraits[key].description}</p>
                                 </div>
                             `).join('')}
                         </div>
                    </div>
                    <div class="no-print text-center pt-6 flex justify-center gap-4">
                        <button id="pdf-button" onclick="generatePDF()" class="bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 transition-colors">Muat Turun Laporan PDF</button>
                        <button onclick="restartSurvey()" class="bg-gray-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-700 transition-colors">Ambil Semula Ujian</button>
                    </div>
                </div>`;
        }

        function renderSpiderChart() {
            const ctx = document.getElementById('personalityChart');
            if (!ctx) return;
            const scores = calculatePersonalityScores();
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Extraversion', 'Agreeableness', 'Conscientiousness', 'Neuroticism', 'Openness'],
                    datasets: [{
                        label: 'Skor Personaliti Anda (%)',
                        data: [scores.extraversion, scores.agreeableness, scores.conscientiousness, scores.neuroticism, scores.openness],
                        fill: true, backgroundColor: 'rgba(59, 130, 246, 0.2)', borderColor: 'rgb(59, 130, 246)',
                        pointBackgroundColor: 'rgb(59, 130, 246)', pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff', pointHoverBorderColor: 'rgb(59, 130, 246)'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: true, scales: { r: { suggestedMin: 0, suggestedMax: 100, pointLabels: { font: { size: 11 } } } }, plugins: { legend: { position: 'top' } } }
            });
        }
        
        window.restartSurvey = function() {
            const submittedEmails = new Set(state.submittedEmails);
            state = {
                currentSection: -1, showResults: false,
                responses: { demographics: {}, personality: {}, wellbeing: {}, resilience: {} },
                submittedEmails: submittedEmails
            };
            render();
            window.scrollTo(0, 0);
        }

        function showModal(message) {
            const existingModal = document.getElementById('alert-modal');
            if (existingModal) existingModal.remove();
            const modalHtml = `<div id="alert-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50 p-4">
                    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-auto">
                        <div class="text-center">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Perhatian!</h3>
                            <div class="mt-2 px-4 py-3"><p class="text-sm text-gray-600">${message}</p></div>
                            <div class="mt-4"><button id="close-modal-btn" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">OK</button></div>
                        </div>
                    </div>
                </div>`;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            document.getElementById('close-modal-btn').onclick = () => document.getElementById('alert-modal').remove();
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', render);
    </script>
</body>
</html>
