<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil Kesejahteraan dan Personaliti Warga</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .progress-bar-animated {
            transition: width 0.5s ease-in-out;
        }
        /* Custom styles for radio buttons to avoid full re-renders */
        .radio-container label {
            transition: all 0.2s ease-in-out;
        }
        .radio-container input:checked + label {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .welcome-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .welcome-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body {
                font-size: 12px;
                line-height: 1.3;
                margin: 0;
                padding: 10px;
            }
            .max-w-4xl { max-width: 100% !important; }
            .p-6 { padding: 8px !important; }
            .space-y-8 > * + * { margin-top: 12px !important; }
            .space-y-4 > * + * { margin-top: 8px !important; }
            .grid { display: block !important; }
            .lg\\:grid-cols-2 > * {
                margin-bottom: 12px !important;
                page-break-inside: avoid;
            }
            table {
                font-size: 11px;
                margin-bottom: 12px;
            }
            .text-3xl { font-size: 18px !important; }
            .text-xl { font-size: 14px !important; }
            .text-lg { font-size: 13px !important; }
            .mb-8 { margin-bottom: 12px !important; }
            .mb-6 { margin-bottom: 8px !important; }
            .mb-4 { margin-bottom: 6px !important; }
            .py-3 { padding-top: 3px !important; padding-bottom: 3px !important; }
            .px-3 { padding-left: 6px !important; padding-right: 6px !important; }
            .px-6 { padding-left: 8px !important; padding-right: 8px !important; }
            .py-3 { padding-top: 4px !important; padding-bottom: 4px !important; }
            .text-5xl { font-size: 24px !important; }
            .text-2xl { font-size: 16px !important; }
            .space-y-4 .bg-blue-100, .space-y-4 .bg-green-100 {
                padding: 6px !important;
                margin-top: 6px !important;
            }
            * { page-break-inside: avoid; }
            .grid.lg\\:grid-cols-2 {
                 display: flex !important;
                 flex-direction: row !important;
                gap: 12px !important;
            }
            .grid.lg\\:grid-cols-2 > div {
                 flex: 1 !important;
                max-width: 48% !important;
            }
        }
        .print-only { display: none; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="max-w-4xl mx-auto p-4 sm:p-6 bg-white min-h-screen">
        <!-- App content will be rendered here -->
        <div class="text-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-4 text-gray-600">Memuatkan soal selidik...</p>
        </div>
    </div>

    <script>
        // --- STATE MANAGEMENT ---
        let state = {
            currentSection: -1, // -1 for welcome page, 0 for demo, 1 for personality, 2 for wellbeing
            showResults: false,
            responses: {
                demographics: {},
                personality: {},
                wellbeing: {}
            },
            submittedEmails: new Set() // In-memory set to track submitted emails for the session
        };

        // --- QUESTIONNAIRE DATA ---
        const demographicsQuestions = [
            { id: 'name', label: 'Nama Penuh', type: 'text', required: true },
            { id: 'ic', label: 'No. MyKad (Tanpa sempang)', type: 'tel', required: true, maxLength: 12, pattern: '[0-9]*' },
            { id: 'email', label: 'Alamat Email', type: 'email', required: true },
            { id: 'gender', label: 'Jantina', type: 'select', options: ['Lelaki', 'Perempuan'], required: true },
            { id: 'race', label: 'Bangsa', type: 'select', options: ['Melayu', 'Cina', 'India', 'Bumiputera Sabah/Sarawak', 'Lain-lain'], required: true },
            { id: 'religion', label: 'Agama', type: 'select', options: ['Islam', 'Buddha', 'Kristian', 'Hindu', 'Lain-lain'], required: true },
            { id: 'phone', label: 'No. Telefon (Bimbit)', type: 'tel', required: true },
            { id: 'ipgKampus', label: 'IPGM/IPGK', type: 'select', options: ['Institut Pendidikan Guru Malaysia (IPGM)', 'IPG Kampus Bahasa Melayu', 'IPG Kampus Bahasa Antarabangsa', 'IPG Kampus Ilmu Khas', 'IPG Kampus Pendidikan Islam', 'IPG Kampus Pendidikan Teknik', 'IPG Kampus Raja Melewar', 'IPG Kampus Tun Hussein Onn', 'IPG Kampus Temenggong Ibrahim', 'IPG Kampus Perempuan Melayu Melaka', 'IPG Kampus Ipoh', 'IPG Kampus Pulau Pinang', 'IPG Kampus Tuanku Bainun', 'IPG Kampus Perlis', 'IPG Kampus Darul Aman', 'IPG Kampus Sultan Abdul Halim', 'IPG Kampus Tengku Ampuan Afzan', 'IPG Kampus Dato\' Razali Ismail', 'IPG Kampus Sultan Mizan', 'IPG Kampus Kota Bharu', 'IPG Kampus Kent', 'IPG Kampus Gaya', 'IPG Kampus Keningau', 'IPG Kampus Tawau', 'IPG Kampus Batu Lintang', 'IPG Kampus Sarawak', 'IPG Kampus Rajang', 'IPG Kampus Tun Abdul Razak', 'English Language Teaching Centre (ELTC)'], required: true },
            { id: 'jawatan', label: 'Jawatan', type: 'select', options: ['REKTOR', 'TIMBALAN REKTOR KANAN', 'TIMBALAN REKTOR', 'KETUA PENOLONG PENGARAH', 'PENOLONG PENGARAH', 'PENGARAH', 'TIMBALAN PENGARAH', 'PENSYARAH', 'KAUNSELOR', 'PEGAWAI PENGURUSAN', 'PEGAWAI GUNASAMA', 'ANGGOTA KHIDMAT PENGURUSAN (AKP)'], required: true },
            { id: 'gred', label: 'Gred', type: 'select', options: ['JUSA B', 'JUSA C', 'DG14', 'DG13', 'DG12', 'DG10', 'DG9', 'F10', 'F9', 'S10', 'S9', 'N2', 'N1'], required: true }
        ];

        const personalityQuestions = [
            'Saya yang menceriakan suasana majlis.',
            'Kurang mengambil berat tentang orang lain.',
            'Sentiasa bersedia.',
            'Mudah berasa tertekan.',
            'Mempunyai kosa kata yang luas.',
            'Tidak banyak bercakap.',
            'Berminat berurusan dengan orang lain.',
            'Meninggalkan barang-barang saya merata-rata.',
            'Tenang pada kebanyakan masa.',
            'Sukar memahami idea-idea abstrak.',
            'Berasa selesa di sekeliling orang.',
            'Menghina orang lain.',
            'Memberikan tumpuan kepada sesuatu perkara secara terperinci.',
            'Bimbang tentang sesuatu perkara.',
            'Mempunyai imaginasi yang jelas.',
            'Suka laksanakan tugas di belakang tabir.',
            'Simpati dengan perasaan orang lain.',
            'Membuat keadaan menjadi kucar-kacir.',
            'Jarang berasa sedih.',
            'Tidak berminat dengan idea-idea abstrak.',
            'Memulakan perbualan dengan orang lain.',
            'Tidak berminat dengan masalah orang lain.',
            'Menyelesaikan tugas dengan segera.',
            'Mudah terganggu.',
            'Mempunyai idea-idea yang cemerlang.',
            'Kurang bercakap.',
            'Berhati lembut.',
            'Sering lupa meletakkan barang kembali ke tempat asal.',
            'Mudah berasa kecewa.',
            'Tidak mempunyai imaginasi yang baik.',
            'Berbual dengan ramai orang di majlis keramaian.',
            'Tidak berminat berurusan dengan orang lain.',
            'Suka kepada keteraturan.',
            'Hati saya kerap berubah-ubah.',
            'Cepat memahami sesuatu perkara.',
            'Tidak suka memberi perhatian kepada diri sendiri.',
            'Meluangkan masa untuk orang lain.',
            'Mengelak daripada tanggungjawab.',
            'Kerap mengalami perubahan emosi.',
            'Menggunakan perkataan yang sukar.',
            'Tidak kisah menjadi perhatian orang lain.',
            'Memahami perasaan orang lain.',
            'Mengikut jadual.',
            'Mudah rasa terganggu.',
            'Meluangkan masa merenung sesuatu perkara.',
            'Diam apabila bersama orang yang tidak dikenali.',
            'Membuat orang lain berasa selesa.',
            'Teliti dalam kerja saya.',
            'Sering berasa sedih.',
            'Penuh dengan idea.'
        ];
        
        const wellbeingQuestions = ['Saya rasa optimistik mengenai masa depan', 'Saya rasa berguna', 'Saya rasa tenang', 'Saya menangani masalah dengan baik', 'Saya berfikir dengan jelas', 'Saya rasa dekat dengan orang lain', 'Saya boleh membuat keputusan sendiri', 'Saya rasa baik tentang diri saya', 'Saya berasa yakin', 'Saya dapat menikmati aktiviti harian saya', 'Saya boleh membuat keputusan terhadap sesuatu perkara', 'Saya rasa disayangi', 'Saya berminat dengan perkara baharu', 'Saya rasa ceria'];

        // --- EVENT HANDLERS & STATE UPDATERS ---
        function startSurvey() {
            state.currentSection = 0;
            render();
            window.scrollTo(0, 0);
        }

        function handleDemographicChange(id, value) {
            const inputElement = document.getElementById(id);
            if (id === 'ic' || id === 'phone') {
                let digitsOnly = value.replace(/\D/g, '');
                
                if (id === 'ic') {
                    digitsOnly = digitsOnly.slice(0, 12);
                    updateICCounter(digitsOnly);
                }
                
                state.responses.demographics[id] = digitsOnly;
                
                if (inputElement) {
                    inputElement.value = digitsOnly;
                }

            } else {
                state.responses.demographics[id] = value;
            }
        }

        function updateICCounter(icValue) {
            const counterElement = document.getElementById('ic-counter');
            if (counterElement) {
                const length = icValue.length;
                counterElement.innerHTML = `<span class="${length === 12 ? 'text-green-600' : 'text-red-500'} font-medium">(${length}/12)</span>`;
            }
        }

        function handlePersonalityChange(index, value) {
            state.responses.personality[index] = parseInt(value);
            updateRadioButtonVisual('personality', index, value);
        }

        function handleWellbeingChange(index, value) {
            state.responses.wellbeing[index] = parseInt(value);
            updateRadioButtonVisual('wellbeing', index, value);
        }

        function updateRadioButtonVisual(section, index, selectedValue) {
            const buttons = document.querySelectorAll(`input[name="${section}-${index}"]`);
            buttons.forEach(button => {
                const label = button.nextElementSibling;
                const baseClass = 'w-8 h-8 sm:w-10 sm:h-10 rounded-full flex items-center justify-center text-sm font-medium transition-all duration-200 cursor-pointer';
                let specificClass = 'bg-gray-200 text-gray-600 hover:bg-gray-300';
                if (parseInt(button.value) === parseInt(selectedValue)) {
                    if (section === 'personality') {
                        specificClass = 'bg-blue-500 text-white shadow-lg transform scale-110';
                    } else {
                        specificClass = 'bg-green-500 text-white shadow-lg transform scale-110';
                    }
                }
                label.className = `${baseClass} ${specificClass}`;
            });
        }

        function validateCurrentSection() {
            if (state.currentSection === 0) {
                for (const field of demographicsQuestions) {
                    if (field.required && !state.responses.demographics[field.id]) {
                        return { isValid: false, message: `Sila lengkapkan maklumat: ${field.label}.` };
                    }
                }
                const icNumber = state.responses.demographics.ic || '';
                if (icNumber.length !== 12) {
                    return { isValid: false, message: `No. MyKad mesti mengandungi tepat 12 digit nombor.` };
                }
                const email = state.responses.demographics.email;
                if (email && state.submittedEmails.has(email.toLowerCase())) {
                    return { isValid: false, message: 'Email ini telah digunakan. Setiap email hanya boleh digunakan sekali sahaja.' };
                }
            } else if (state.currentSection === 1) {
                if (Object.keys(state.responses.personality).length < personalityQuestions.length) {
                    return { isValid: false, message: 'Sila jawab semua soalan dalam Bahagian B.' };
                }
            } else if (state.currentSection === 2) {
                if (Object.keys(state.responses.wellbeing).length < wellbeingQuestions.length) {
                    return { isValid: false, message: 'Sila jawab semua soalan dalam Bahagian C.' };
                }
            }
            return { isValid: true };
        }

        function handleNextSection() {
            const validation = validateCurrentSection();
            if (!validation.isValid) {
                showModal(validation.message);
                return;
            }
            state.currentSection++;
            render();
            window.scrollTo(0, 0);
        }

        function handlePrevSection() {
            state.currentSection = Math.max(0, state.currentSection - 1);
            render();
            window.scrollTo(0, 0);
        }

        // --- SCORE CALCULATIONS ---
        function calculatePersonalityScores() {
            const r = state.responses.personality;
            const p = (index) => r[index - 1] || 3;

            const scores = {
                extraversion: 20 + p(1) - p(6) + p(11) - p(16) + p(21) - p(26) + p(31) - p(36) + p(41) - p(46),
                agreeableness: 14 - p(2) + p(7) - p(12) + p(17) - p(22) + p(27) - p(32) + p(37) + p(42) + p(47),
                conscientiousness: 14 + p(3) - p(8) + p(13) - p(18) + p(23) - p(28) + p(33) - p(38) + p(43) + p(48),
                neuroticism: 38 - p(4) + p(9) - p(14) + p(19) - p(24) - p(29) - p(34) - p(39) - p(44) - p(49),
                openness: 8 + p(5) - p(10) + p(15) - p(20) + p(25) - p(30) + p(35) + p(40) + p(45) + p(50)
            };
            
            scores.neuroticism = 40 - scores.neuroticism;

            return {
                extraversion: Math.max(0, Math.min(100, Math.round((scores.extraversion / 40) * 100))),
                agreeableness: Math.max(0, Math.min(100, Math.round((scores.agreeableness / 40) * 100))),
                conscientiousness: Math.max(0, Math.min(100, Math.round((scores.conscientiousness / 40) * 100))),
                neuroticism: Math.max(0, Math.min(100, Math.round((scores.neuroticism / 40) * 100))),
                openness: Math.max(0, Math.min(100, Math.round((scores.openness / 40) * 100)))
            };
        }

        function calculateWellbeingScore() {
            const totalScore = Object.values(state.responses.wellbeing).reduce((sum, score) => sum + (score || 0), 0);
            return {
                total: totalScore,
                percentage: Math.round(((totalScore - 14) / (70 - 14)) * 100)
            };
        }

        // --- DATA SUBMISSION ---
        async function sendToGoogleSheets(data) {
            const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbwvRmvasIBftLSqzzJcCAqan2sBaeqRmdgG0_YSFYl__Ym8S3NeNo-RPLsOTrXjV0m7/exec';
            try {
                await fetch(GOOGLE_SHEETS_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                console.log('✅ Data submission attempted. Check Google Sheets for result.');
                return true;
            } catch (error) {
                console.error('❌ Error sending data to Google Sheets:', error);
                showModal("Maaf, terdapat ralat semasa menghantar data anda. Sila cuba lagi.");
                return false;
            }
        }
        
        function showResults() {
            const validation = validateCurrentSection();
            if (!validation.isValid) {
                showModal(validation.message);
                return;
            }
            
            const email = state.responses.demographics.email;
            if (email) {
                state.submittedEmails.add(email.toLowerCase());
            }

            const personalityScores = calculatePersonalityScores();
            const wellbeingScore = calculateWellbeingScore();

            const getTahap = (score) => {
                if (score >= 67) return 'Tinggi';
                if (score >= 34) return 'Sederhana';
                return 'Rendah';
            };
            const tahapKesejahteraan = wellbeingScore.total >= 45 ? "Tinggi" : wellbeingScore.total >= 25 ? "Sederhana" : "Rendah";

            const personalityRanked = Object.entries(personalityScores)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 3)
                .map(([key]) => key.charAt(0).toUpperCase() + key.slice(1));

            const sheetData = {
                timestamp: new Date().toLocaleString('en-GB', { timeZone: 'Asia/Kuala_Lumpur' }),
                nama: state.responses.demographics.name || '',
                mykad: state.responses.demographics.ic || '',
                email: state.responses.demographics.email || '',
                jantina: state.responses.demographics.gender || '',
                bangsa: state.responses.demographics.race || '',
                agama: state.responses.demographics.religion || '',
                telefon: state.responses.demographics.phone || '',
                ipgKampus: state.responses.demographics.ipgKampus || '',
                jawatan: state.responses.demographics.jawatan || '',
                gred: state.responses.demographics.gred || '',
                
                extraversion: personalityScores.extraversion,
                tahap_extraversion: getTahap(personalityScores.extraversion),
                agreeableness: personalityScores.agreeableness,
                tahap_agreeableness: getTahap(personalityScores.agreeableness),
                conscientiousness: personalityScores.conscientiousness,
                tahap_conscientiousness: getTahap(personalityScores.conscientiousness),
                neuroticism: personalityScores.neuroticism,
                tahap_neuroticism: getTahap(personalityScores.neuroticism),
                openness: personalityScores.openness,
                tahap_openness: getTahap(personalityScores.openness),
                
                domain_1: personalityRanked[0] || '',
                domain_2: personalityRanked[1] || '',
                domain_3: personalityRanked[2] || '',

                ...Object.fromEntries(Array.from({length: 50}, (_, i) => [`p${i+1}`, state.responses.personality[i] || 0])),
                
                wellbeingTotal: wellbeingScore.total,
                wellbeingPercentage: wellbeingScore.percentage,
                tahap_kesejahteraan: tahapKesejahteraan,

                ...Object.fromEntries(Array.from({length: 14}, (_, i) => [`w${i+1}`, state.responses.wellbeing[i] || 0]))
            };

            sendToGoogleSheets(sheetData);
            
            state.showResults = true;
            render();
            window.scrollTo(0, 0);
        }

        // --- PDF GENERATION ---
        async function generatePDF() {
            const pdfButton = document.getElementById('pdf-button');
            pdfButton.disabled = true;
            pdfButton.innerHTML = `<div class="flex items-center justify-center"><svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Menjana PDF...</div>`;

            const { demographics } = state.responses;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'pt', 'a4');

            const resultsContent = document.getElementById('results-content');
            // Temporarily remove the download button from the content to be captured
            const downloadButtonContainer = resultsContent.querySelector('.no-print');
            downloadButtonContainer.style.display = 'none';

            const canvas = await html2canvas(resultsContent, { scale: 2 });
            
            // Restore the download button
            downloadButtonContainer.style.display = 'block';

            const imgData = canvas.toDataURL('image/png');
            
            const pdfWidth = doc.internal.pageSize.getWidth();
            const pdfHeight = doc.internal.pageSize.getHeight();
            const imgWidth = canvas.width;
            const imgHeight = canvas.height;
            const ratio = imgWidth / imgHeight;
            let newImgWidth = pdfWidth;
            let newImgHeight = newImgWidth / ratio;

            if (newImgHeight > pdfHeight) {
                newImgHeight = pdfHeight;
                newImgWidth = newImgHeight * ratio;
            }

            const xOffset = (pdfWidth - newImgWidth) / 2;
            const yOffset = (pdfHeight - newImgHeight) / 2;

            doc.addImage(imgData, 'PNG', xOffset, yOffset, newImgWidth, newImgHeight);
            
            doc.save(`Profil_Kesejahteraan_${demographics.name.replace(/ /g, '_')}.pdf`);
            pdfButton.disabled = false;
            pdfButton.innerHTML = 'Muat Turun Laporan PDF';
        }
        
        // --- UI RENDERING ---
        function render() {
            const app = document.getElementById('app');
            app.className = "max-w-4xl mx-auto p-4 sm:p-6 bg-white min-h-screen shadow-lg rounded-lg border border-gray-200 fade-in";
            
            if (state.currentSection === -1) {
                app.innerHTML = renderWelcomePage();
            } else if (state.showResults) {
                app.innerHTML = renderResults();
                setTimeout(renderSpiderChart, 100);
            } else {
                const totalSections = 3;
                const progress = ((state.currentSection + 1) / totalSections) * 100;
                let content = '';
                if (state.currentSection === 0) content = renderDemographics();
                else if (state.currentSection === 1) content = renderPersonality();
                else if (state.currentSection === 2) content = renderWellbeing();

                app.innerHTML = `
                    <div class="mb-6">
                        <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 text-center">Profil Kesejahteraan dan Personaliti Warga IPG</h1>
                        <p class="text-center text-gray-500 mt-2">Unit Psikologi dan Kaunseling, IPGM</p>
                        <div class="mt-6">
                            <div class="bg-gray-200 rounded-full h-2.5">
                                <div class="bg-blue-600 h-2.5 rounded-full progress-bar-animated" style="width: ${progress}%"></div>
                            </div>
                            <p class="text-sm text-right text-gray-600 mt-1">Bahagian ${state.currentSection + 1} dari ${totalSections}</p>
                        </div>
                    </div>
                    ${content}
                `;
            }
            attachListeners();
        }

        function renderWelcomePage() {
            return `
                <div class="text-center py-10 px-4 fade-in">
                    <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Selamat Datang</h1>
                    <p class="mt-4 text-lg text-gray-600 max-w-2xl mx-auto">Profil Kesejahteraan dan Personaliti Warga (PKPW) adalah ujian bagi mengenalpasti tahap kesejahteraan psikologi dan tret personaliti warga kerja di IPGKPM.</p>
                    <p class="mt-2 text-lg text-gray-600 max-w-2xl mx-auto font-bold">Komitmen masa untuk menjawab adalah 20 minit</p>
                    
                    <div class="mt-12">
                        <h2 class="text-2xl font-semibold text-gray-700 mb-8">Tinjauan Soal Selidik</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-4xl mx-auto">
                            <!-- Card 1 -->
                            <div class="welcome-card bg-white p-6 rounded-lg border border-gray-200 shadow-md">
                                <div class="flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 text-blue-600 mx-auto mb-4">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                </div>
                                <h3 class="text-lg font-bold text-gray-800">Bahagian A</h3>
                                <p class="text-gray-600 font-semibold">Maklumat Diri</p>
                                <p class="mt-2 text-sm text-gray-500">Beberapa soalan asas demografi untuk tujuan statistik.</p>
                            </div>
                            <!-- Card 2 -->
                            <div class="welcome-card bg-white p-6 rounded-lg border border-gray-200 shadow-md">
                                <div class="flex items-center justify-center h-12 w-12 rounded-full bg-purple-100 text-purple-600 mx-auto mb-4">
                                     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.871 4A1.928 1.928 0 003 5.871V18.13A1.928 1.928 0 004.871 20H19.13A1.928 1.928 0 0021 18.129V5.87A1.928 1.928 0 0019.129 4H4.87Z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15a3 3 0 100-6 3 3 0 000 6Z"></path></svg>
                                </div>
                                <h3 class="text-lg font-bold text-gray-800">Bahagian B</h3>
                                <p class="text-gray-600 font-semibold">Personaliti Diri</p>
                                <p class="mt-2 text-sm text-gray-500">50 item untuk meneroka 5 dimensi utama personaliti anda.</p>
                            </div>
                            <!-- Card 3 -->
                            <div class="welcome-card bg-white p-6 rounded-lg border border-gray-200 shadow-md">
                                <div class="flex items-center justify-center h-12 w-12 rounded-full bg-green-100 text-green-600 mx-auto mb-4">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>
                                </div>
                                <h3 class="text-lg font-bold text-gray-800">Bahagian C</h3>
                                <p class="text-gray-600 font-semibold">Kesejahteraan Psikologi</p>
                                <p class="mt-2 text-sm text-gray-500">14 item untuk mengukur tahap kesejahteraan psikologi anda.</p>
                            </div>
                        </div>
                    </div>

                    <div class="mt-12">
                        <button onclick="startSurvey()" class="bg-blue-600 text-white font-bold py-3 px-10 rounded-lg hover:bg-blue-700 transition-colors text-lg shadow-lg hover:shadow-xl">
                            Mula Soal Selidik
                        </button>
                    </div>
                </div>
            `;
        }

        function renderDemographics() {
            const fieldsHtml = demographicsQuestions.map(q => {
                const value = state.responses.demographics[q.id] || '';
                let inputHtml = '';
                switch (q.type) {
                    case 'select':
                        inputHtml = `
                            <select id="${q.id}" name="${q.id}" onchange="handleDemographicChange('${q.id}', this.value)" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm" ${q.required ? 'required' : ''}>
                                <option value="" disabled ${!value ? 'selected' : ''}>Sila pilih...</option>
                                ${q.options.map(opt => `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                            </select>`;
                        break;
                    case 'text':
                    case 'email':
                    case 'tel':
                         const isIC = q.id === 'ic';
                         inputHtml = `
                            <div class="relative rounded-md shadow-sm">
                                <input type="${q.type}" id="${q.id}" name="${q.id}" value="${value}" oninput="handleDemographicChange('${q.id}', this.value)"
                                       class="block w-full pl-3 pr-10 py-2 border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                       ${q.required ? 'required' : ''} ${q.maxLength ? `maxlength="${q.maxLength}"` : ''} ${q.pattern ? `pattern="${q.pattern}"` : ''}>
                                ${isIC ? `<div id="ic-counter" class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm text-gray-500 pointer-events-none"></div>` : ''}
                            </div>`;
                        break;
                }
                return `
                    <div>
                        <label for="${q.id}" class="block text-sm font-medium text-gray-700 mb-1">
                            ${q.label}
                        </label>
                        ${inputHtml}
                    </div>
                `;
            }).join('');
        
            return `
                <div class="space-y-6">
                    <div class="p-5 bg-blue-50 border border-blue-200 rounded-lg">
                        <h2 class="text-xl font-semibold text-gray-800">Bahagian A: Maklumat Diri</h2>
                        <p class="text-gray-600 mt-1">Sila lengkapkan semua maklumat di bawah.</p>
                    </div>
                    <div class="px-4 py-5 sm:p-6">
                        <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-6">
                            ${demographicsQuestions.map(q => {
                                const value = state.responses.demographics[q.id] || '';
                                let inputHtml = '';
                                const colSpan = ['name', 'email', 'ipgKampus'].includes(q.id) ? 'sm:col-span-6' : 'sm:col-span-3';
                                switch (q.type) {
                                    case 'select':
                                        inputHtml = `<select id="${q.id}" name="${q.id}" onchange="handleDemographicChange('${q.id}', this.value)" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm" ${q.required ? 'required' : ''}>
                                            <option value="" disabled ${!value ? 'selected' : ''}>Sila pilih...</option>
                                            ${q.options.map(opt => `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                        </select>`;
                                        break;
                                    case 'text':
                                    case 'email':
                                    case 'tel':
                                        const isIC = q.id === 'ic';
                                        inputHtml = `<div class="relative rounded-md shadow-sm">
                                            <input type="${q.type}" id="${q.id}" name="${q.id}" value="${value}" oninput="handleDemographicChange('${q.id}', this.value)"
                                                   class="block w-full pl-3 pr-12 py-2 border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                                   ${q.required ? 'required' : ''} ${q.maxLength ? `maxlength="${q.maxLength}"` : ''} ${q.pattern ? `pattern="${q.pattern}"` : ''}>
                                            ${isIC ? `<div id="ic-counter" class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm text-gray-500 pointer-events-none"></div>` : ''}
                                        </div>`;
                                        break;
                                }
                                return `<div class="${colSpan}">
                                    <label for="${q.id}" class="block text-sm font-medium text-gray-700">${q.label}</label>
                                    ${inputHtml}
                                </div>`;
                            }).join('')}
                        </div>
                    </div>
                    <div class="flex justify-end pt-4 px-4 sm:px-6">
                        <button onclick="handleNextSection()" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">Seterusnya</button>
                    </div>
                </div>
            `;
        }

        function renderQuestionnaire(title, questions, responses, sectionName, colorClass) {
            const questionsHtml = questions.map((q, index) => {
                const selectedValue = responses[index];
                const radioButtons = [1, 2, 3, 4, 5].map(v => {
                    let specificClass = 'bg-gray-200 text-gray-600 hover:bg-gray-300';
                    if (v === selectedValue) {
                        specificClass = `${colorClass.bg} text-white shadow-lg transform scale-110`;
                    }
                    return `
                        <div class="radio-container">
                            <input type="radio" id="${sectionName}-${index}-${v}" name="${sectionName}-${index}" value="${v}" class="sr-only" onchange="handle${sectionName.charAt(0).toUpperCase() + sectionName.slice(1)}Change(${index}, this.value)" ${v === selectedValue ? 'checked' : ''}>
                            <label for="${sectionName}-${index}-${v}" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full flex items-center justify-center text-sm font-medium transition-all duration-200 cursor-pointer ${specificClass}">
                                ${v}
                            </label>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="p-4 rounded-lg border ${selectedValue ? colorClass.border : 'border-gray-200'} bg-white shadow-sm">
                        <p class="text-gray-800 mb-3">${index + 1}. ${q}</p>
                        <div class="flex justify-between items-center space-x-2 sm:space-x-3">
                            <span class="text-xs text-gray-500 text-center hidden sm:block">Sangat<br>Tidak Setuju</span>
                            ${radioButtons}
                            <span class="text-xs text-gray-500 text-center hidden sm:block">Sangat<br>Setuju</span>
                        </div>
                    </div>
                `;
            }).join('');

            const headerColor = colorClass.bg.replace('bg-', '');
            return `
                <div class="space-y-6">
                    <div class="p-5 bg-${headerColor}-50 border border-${headerColor}-200 rounded-lg">
                        <h2 class="text-xl font-semibold text-gray-800">${title}</h2>
                        <p class="text-gray-600 mt-1">Pilih jawapan yang paling menggambarkan diri anda.</p>
                        <div class="flex justify-between text-xs text-gray-600 mt-4 px-2 sm:hidden">
                            <span>1 = Sangat Tidak Setuju</span>
                            <span>5 = Sangat Setuju</span>
                        </div>
                    </div>
                    <div class="space-y-4">
                        ${questionsHtml}
                    </div>
                    <div class="flex justify-between pt-4">
                        <button onclick="handlePrevSection()" class="bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-400 transition-colors">Kembali</button>
                        ${sectionName === 'wellbeing' ?
                            `<button onclick="showResults()" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition-colors">Hantar & Lihat Keputusan</button>` :
                            `<button onclick="handleNextSection()" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">Seterusnya</button>`
                        }
                    </div>
                </div>
            `;
        }

        function renderPersonality() {
            return renderQuestionnaire('Bahagian B: Personaliti Diri', personalityQuestions, state.responses.personality, 'personality', { bg: 'bg-blue-500', border: 'border-blue-300' });
        }

        function renderWellbeing() {
            return renderQuestionnaire('Bahagian C: Kesejahteraan Diri', wellbeingQuestions, state.responses.wellbeing, 'wellbeing', { bg: 'bg-green-500', border: 'border-green-300' });
        }

        function renderResults() {
            const { name } = state.responses.demographics;
            const wellbeingScore = calculateWellbeingScore();
            const personalityScores = calculatePersonalityScores();
            const getTahap = (score) => {
                if (score >= 67) return 'Tinggi';
                if (score >= 34) return 'Sederhana';
                return 'Rendah';
            };

            const interpretations = {
                Extraversion: {
                    Tinggi: 'Suka bergaul, bertenaga, dan selesa dalam kumpulan.',
                    Sederhana: 'Seimbang antara sosial dan bersendirian.',
                    Rendah: 'Lebih suka bersendirian, pendiam, dan pemalu.'
                },
                Agreeableness: {
                    Tinggi: 'Suka bekerjasama, mudah mempercayai, dan baik hati.',
                    Sederhana: 'Seimbang antara bekerjasama dan kepentingan diri.',
                    Rendah: 'Lebih skeptikal, suka bertanding, dan berterus-terang.'
                },
                Conscientiousness: {
                    Tinggi: 'Sangat berdisiplin, teratur, dan bertanggungjawab.',
                    Sederhana: 'Gabungan antara teratur dan fleksibel.',
                    Rendah: 'Lebih fleksibel, spontan, dan kurang teratur.'
                },
                Neuroticism: {
                    Tinggi: 'Cenderung untuk berasa cemas, risau, dan tidak stabil dari segi emosi.',
                    Sederhana: 'Responsif terhadap emosi tetapi secara amnya stabil.',
                    Rendah: 'Tenang, stabil dari segi emosi, dan berdaya tahan.'
                },
                Openness: {
                    Tinggi: 'Sangat kreatif, imaginatif, dan ingin tahu.',
                    Sederhana: 'Keseimbangan antara kreativiti dan praktikaliti.',
                    Rendah: 'Lebih praktikal, konvensional, dan suka kepada rutin.'
                }
            };

            const personalityData = [
                { label: 'Extraversion', score: personalityScores.extraversion, color: 'text-red-600' },
                { label: 'Agreeableness', score: personalityScores.agreeableness, color: 'text-yellow-600' },
                { label: 'Conscientiousness', score: personalityScores.conscientiousness, color: 'text-green-600' },
                { label: 'Neuroticism', score: personalityScores.neuroticism, color: 'text-purple-600' },
                { label: 'Openness', score: personalityScores.openness, color: 'text-blue-600' }
            ];

            const wellbeingStatus = wellbeingScore.total >= 45 ? "Tinggi" : wellbeingScore.total >= 25 ? "Sederhana" : "Rendah";
            const wellbeingDesc = {
                "Tinggi": "Anda menunjukkan tahap kesejahteraan psikologi yang sangat baik. Anda berkemungkinan besar berasa gembira, berfungsi dengan baik dan dapat menangani cabaran hidup.",
                "Sederhana": "Anda mempunyai tahap kesejahteraan psikologi yang sederhana. Terdapat ruang untuk penambahbaikan dalam beberapa aspek kehidupan anda untuk meningkatkan lagi kebahagiaan dan daya tahan anda.",
                "Rendah": "Skor anda menunjukkan tahap kesejahteraan psikologi yang rendah. Anda mungkin sedang menghadapi kesukaran. Pertimbangkan untuk mendapatkan sokongan daripada kaunselor atau profesional kesihatan mental."
            };
            const wellbeingColors = {
                Tinggi: {
                    text: 'text-green-700', title: 'text-green-800', score: 'text-green-600',
                    bg: 'bg-green-50', border: 'border-green-200', innerBg: 'bg-green-100'
                },
                Sederhana: {
                    text: 'text-yellow-700', title: 'text-yellow-800', score: 'text-yellow-600',
                    bg: 'bg-yellow-50', border: 'border-yellow-300', innerBg: 'bg-yellow-100'
                },
                Rendah: {
                    text: 'text-red-700', title: 'text-red-800', score: 'text-red-600',
                    bg: 'bg-red-50', border: 'border-red-200', innerBg: 'bg-red-100'
                }
            };
            const wColor = wellbeingColors[wellbeingStatus];
            
            return `
                <div id="results-content" class="p-6 bg-white rounded-lg">
                    <div class="text-center">
                        <h1 class="text-3xl font-bold text-gray-800">Keputusan Profil Anda</h1>
                        <p class="text-lg text-gray-600 mt-2">Terima kasih, ${name || 'Warga IPG'}, kerana melengkapkan soal selidik ini.</p>
                        <div class="my-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <p class="text-blue-800"><strong>Penting:</strong> Keputusan ini adalah berdasarkan maklum balas anda. Ia bertujuan untuk memberi gambaran umum dan kesedaran diri, bukan diagnosis klinikal.</p>
                        </div>
                    </div>

                    <div class="grid lg:grid-cols-5 gap-8 mt-8">
                        <!-- Personality Section -->
                        <div class="lg:col-span-3 p-6 bg-blue-50 border border-blue-200 rounded-lg">
                            <h2 class="text-2xl font-bold text-blue-700 mb-4 text-left">Profil Personaliti Diri</h2>
                            <div class="w-full max-w-md mx-auto">
                                <canvas id="personalityChart"></canvas>
                            </div>
                        </div>

                        <!-- Wellbeing Section -->
                        <div class="lg:col-span-2 p-6 ${wColor.bg} ${wColor.border} rounded-lg flex flex-col justify-center items-center text-center">
                            <h2 class="text-2xl font-bold ${wColor.title} mb-4">Tahap Kesejahteraan Psikologi</h2>
                            <p class="${wColor.text} text-sm">Berdasarkan Skala WEMWBS</p>
                            <div class="my-6">
                                <p class="text-5xl font-bold ${wColor.score}">${wellbeingScore.total}<span class="text-2xl text-gray-500">/70</span></p>
                                <p class="text-2xl font-semibold ${wColor.title} mt-2">Tahap: ${wellbeingStatus}</p>
                            </div>
                            <div class="${wColor.innerBg} p-4 rounded-lg">
                                <p class="${wColor.text} text-sm">${wellbeingDesc[wellbeingStatus]}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Interpretation Table -->
                    <div class="mt-10">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Interpretasi Personaliti Diri</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white border border-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dimensi</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tahap Anda</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Interpretasi</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${personalityData.map(trait => `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap font-bold ${trait.color}">${trait.label}</td>
                                            <td class="px-6 py-4 whitespace-nowrap font-semibold">${getTahap(trait.score)}</td>
                                            <td class="px-6 py-4 text-sm text-gray-600">${interpretations[trait.label][getTahap(trait.score)]}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="mt-10 text-center no-print">
                        <p class="text-gray-600 mb-4">Simpan salinan keputusan anda dalam format PDF.</p>
                        <button id="pdf-button" onclick="generatePDF()" class="bg-gray-800 text-white font-bold py-3 px-8 rounded-lg hover:bg-gray-900 transition-colors text-lg disabled:bg-gray-400 disabled:cursor-not-allowed">
                            Muat Turun Laporan PDF
                        </button>
                    </div>
                </div>
            `;
        }

        function renderSpiderChart() {
            const ctx = document.getElementById('personalityChart');
            if (!ctx) return;
            const personalityScores = calculatePersonalityScores();
            
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Extraversion', 'Agreeableness', 'Conscientiousness', 'Neuroticism', 'Openness'],
                    datasets: [{
                        label: 'Skor Personaliti (%)',
                        data: [
                            personalityScores.extraversion,
                            personalityScores.agreeableness,
                            personalityScores.conscientiousness,
                            personalityScores.neuroticism,
                            personalityScores.openness
                        ],
                        fill: true,
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: 'rgb(59, 130, 246)',
                        pointBackgroundColor: 'rgb(59, 130, 246)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(59, 130, 246)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(0, 0, 0, 0.1)' },
                            grid: { color: 'rgba(0, 0, 0, 0.1)' },
                            pointLabels: {
                                font: { size: 12, weight: 'bold' },
                                color: '#333'
                            },
                            ticks: {
                                beginAtZero: true, max: 100, stepSize: 20,
                                backdropColor: 'rgba(255, 255, 255, 0.75)',
                                color: '#666'
                            }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }
        
        function showModal(message) {
            const existingModal = document.getElementById('alert-modal');
            if (existingModal) existingModal.remove();
            const modalHTML = `
                <div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 fade-in">
                    <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
                        <h3 class="text-lg font-bold text-red-600 mb-4">Perhatian!</h3>
                        <p class="text-gray-700 mb-6">${message}</p>
                        <button onclick="closeModal()" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">OK</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function closeModal() {
            const modal = document.getElementById('alert-modal');
            if (modal) modal.remove();
        }

        // --- INITIALIZATION ---
        function attachListeners() {
            const icInput = document.getElementById('ic');
            if (icInput) {
                updateICCounter(icInput.value);
            }
        }

        document.addEventListener('DOMContentLoaded', render);

    </script>
</body>
</html>
