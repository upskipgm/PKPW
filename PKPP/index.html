<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profil Kesejahteraan dan Personaliti Pelajar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.23/dist/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .progress-bar-animated {
            transition: width 0.5s ease-in-out;
        }
        .radio-container label {
            transition: all 0.2s ease-in-out;
        }
        .radio-container input:checked + label {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .welcome-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .welcome-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        /* Modal Styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-backdrop.visible {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 400px;
            text-align: center;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-backdrop.visible .modal-content {
            transform: scale(1);
        }
        @media print {
            body * {
                visibility: hidden;
            }
            #results-container, #results-container * {
                visibility: visible;
            }
            #results-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="max-w-4xl mx-auto p-4 sm:p-6 bg-white min-h-screen shadow-lg rounded-lg">
        <!-- App content will be rendered here -->
        <div class="text-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-4 text-gray-600">Memuatkan soal selidik...</p>
        </div>
    </div>
    <footer class="text-center py-4 text-sm text-gray-500 bg-gray-50 no-print">
        2024@Unit Psikologi dan Kaunseling, IPGM
    </footer>

    <!-- Modal container -->
    <div id="modal-container"></div>

    <script>
        // --- STATE MANAGEMENT ---
        let state = {
            currentSection: -1, // -1:welcome, 0:demo, 1:guardian, 2:personality, 3:ikpsi
            showResults: false,
            responses: {
                demographics: {},
                guardianDemographics: {},
                personality: {},
                ikpsi: {}
            },
            submittedEmails: new Set() // In-memory set to track submitted emails for the session
        };

        // --- QUESTIONNAIRE DATA ---
        const demographicsQuestions = [
            { id: 'name', label: 'Nama Penuh', type: 'text', required: true },
            { id: 'ic', label: 'No. MyKad (Tanpa sempang)', type: 'tel', required: true, maxLength: 12, pattern: '[0-9]*' },
            { id: 'email', label: 'Alamat Email', type: 'email', required: true },
            { id: 'gender', label: 'Jantina', type: 'select', options: ['Lelaki', 'Perempuan'], required: true },
            { id: 'race', label: 'Bangsa', type: 'select', options: ['Melayu', 'Cina', 'India', 'Bumiputera Sabah/Sarawak', 'Lain-lain'], required: true },
            { id: 'religion', label: 'Agama', type: 'select', options: ['Islam', 'Buddha', 'Kristian', 'Hindu', 'Lain-lain'], required: true },
            { id: 'phone', label: 'No. Telefon (Bimbit)', type: 'tel', required: true },
            { id: 'ipgKampus', label: 'IPGM/IPGK', type: 'select', options: ['IPG Kampus Bahasa Melayu', 'IPG Kampus Bahasa Antarabangsa', 'IPG Kampus Ilmu Khas', 'IPG Kampus Pendidikan Islam', 'IPG Kampus Pendidikan Teknik', 'IPG Kampus Raja Melewar', 'IPG Kampus Tun Hussein Onn', 'IPG Kampus Temenggong Ibrahim', 'IPG Kampus Perempuan Melayu Melaka', 'IPG Kampus Ipoh', 'IPG Kampus Pulau Pinang', 'IPG Kampus Tuanku Bainun', 'IPG Kampus Perlis', 'IPG Kampus Darul Aman', 'IPG Kampus Sultan Abdul Halim', 'IPG Kampus Tengku Ampuan Afzan', 'IPG Kampus Dato\' Razali Ismail', 'IPG Kampus Sultan Mizan', 'IPG Kampus Kota Bharu', 'IPG Kampus Kent', 'IPG Kampus Gaya', 'IPG Kampus Keningau', 'IPG Kampus Tawau', 'IPG Kampus Batu Lintang', 'IPG Kampus Sarawak', 'IPG Kampus Rajang', 'IPG Kampus Tun Abdul Razak'], required: true },
            { id: 'program', label: 'Program', type: 'select', options: ['PPISMP', 'PISMP', 'PISP', 'PDPP', 'PDPP KDC'], required: true },
            { id: 'semester', label: 'Semester', type: 'select', options: ['Semester 1', 'Semester 2', 'Semester 3', 'Semester 4', 'Semester 5', 'Semester 6', 'Semester 7', 'Semester 8', 'Semester 9', 'Semester 10', 'Semester 11', 'Semester 12'], required: true }
        ];

        const guardianDemographicsQuestions = [
            { id: 'guardian_name', label: 'Nama Ibu/Bapa/Penjaga', type: 'text', required: true },
            { id: 'guardian_phone', label: 'No. Telefon Ibu/Bapa/Penjaga', type: 'tel', required: true },
            { id: 'guardian_income', label: 'Jumlah Pendapatan Kasar Bulanan Isi Rumah', type: 'select', options: ['Tiada Pendapatan', 'Kurang dari RM2,500 (B40)', 'RM2,501 - RM5,000 (B40)', 'RM5,001 - RM10,960 (M40)', 'Lebih dari RM10,961 (T20)'], required: true },
        ];

        const personalityQuestions = [
            'Saya seorang yang menceriakan suasana majlis.', 'Saya kurang mengambil berat tentang orang lain.', 'Saya sentiasa bersedia.', 'Saya mudah berasa tertekan.', 'Saya mempunyai kosa kata yang luas.', 'Saya tidak banyak bercakap.', 'Saya cenderung untuk berurusan dengan orang lain.', 'Saya sering meninggalkan barang di merata tempat.', 'Saya tenang pada kebanyakan masa.', 'Saya sukar memahami idea-idea abstrak.', 'Saya berasa selesa dikelilingi orang ramai.', 'Saya sering menghina orang lain.', 'Saya memberikan tumpuan kepada sesuatu perkara secara terperinci.', 'Saya bimbang tentang sesuatu perkara.', 'Saya mempunyai imaginasi yang jelas.', 'Saya suka laksanakan tugas di belakang tabir.', 'Saya simpati dengan perasaan orang lain.', 'Saya sering membuat keadaan menjadi kucar-kacir.', 'Saya jarang berasa sedih.', 'Saya tidak berminat dengan idea-idea abstrak.', 'Saya selalu memulakan perbualan dengan orang lain.', 'Saya tidak berminat dengan masalah orang lain.', 'Saya menyelesaikan tugas dengan segera.', 'Saya mudah terganggu.', 'Saya mempunyai idea-idea yang bernas.', 'Saya kurang bercakap.', 'Saya seorang yang berhati lembut.', 'Saya sering lupa meletakkan kembali barang ke tempat asal.', 'Saya mudah berasa kecewa.', 'Saya tidak mempunyai imaginasi yang baik.', 'Saya selesa berbual dengan ramai orang di sesuatu majlis.', 'Saya tidak berminat berurusan dengan orang lain.', 'Saya suka kepada keteraturan.', 'Hati saya kerap berubah-ubah.', 'Saya cepat memahami sesuatu perkara.', 'Saya tidak suka memberi perhatian kepada diri sendiri.', 'Saya meluangkan masa untuk orang lain.', 'Saya mengelak daripada tanggungjawab.', 'Saya kerap mengalami perubahan emosi.', 'Saya sering menggunakan perkataan yang sukar.', 'Saya tidak kisah menjadi perhatian orang lain.', 'Saya memahami perasaan orang lain.', 'Saya seorang yang mengikut jadual.', 'Saya mudah rasa terganggu.', 'Saya selalu meluangkan masa meneliti sesuatu perkara.', 'Saya akan diam apabila bersama orang yang tidak dikenali.', 'Saya selalu membuat orang lain berasa selesa.', 'Saya teliti dalam kerja saya.', 'Saya sering berasa sedih.', 'Saya seorang yang banyak idea.'
        ];
        
        const ikpsiQuestions = [
            "Saya dapat mengenal emosi orang lain dengan baik.", "Saya dapat mengenal emosi saya dengan sepenuhnya.", "Saya sedar keadaan emosi yang sedang saya alami.", "Saya dapat menyelami emosi orang lain.", "Saya memahami perubahan emosi yang berlaku dalam diri saya.", "Saya memahami bahawa emosi saya boleh mempengaruhi tingkah laku orang lain.", "Saya mampu mengawal emosi walaupun dalam keadaan tertekan", "Saya mampu bertenang walaupun sedang marah.", "Saya dapat menangani tekanan dengan baik.", "Saya tidak pernah marah dalam hidup.", "Saya bertanggungjawab atas bidang pengajian yang saya pilih.", "Saya seorang yang berdikari.", "Saya bertanggungjawab terhadap laluan kerjaya yang saya pilih.", "Saya mampu memperkembang potensi diri secara berterusan.", "Saya suka akan situasi baharu yang dapat memperbaiki diri.", "Saya bersedia menerima pengalaman baharu.", "Saya suka menerima pengiktirafan atas tugasan yang saya lakukan.", "Saya memberikan ganjaran terhadap diri sendiri.", "Saya menjalankan tugas dengan baik tanpa mengharapkan pengiktirafan.", "Saya mempunyai masa untuk melakukan aktiviti yang saya sukai.", "Saya berupaya membahagikan masa untuk aktiviti belajar dengan kehidupan peribadi.", "Saya dapat menguruskan kehidupan peribadi dengan seimbang.", "Saya tidak pernah gagal dalam hidup.", "Saya mengamalkan pemakanan seimbang.", "Saya sihat jika mengambil makanan yang berkhasiat.", "Saya mengambil makanan yang berkhasiat untuk keperluan tubuh badan.", "Saya prihatin tentang berat badan saya.", "Saya akan membuat regangan apabila duduk terlalu lama.", "Saya memilih beriadah berbanding berehat di bilik.", "Saya mandi setiap hari untuk memastikan badan saya bersih.", "Saya mencuci tangan untuk mengekalkan kebersihan.", "Saya menjaga kebersihan walau di manan-mana saya berada.", "Saya mengambil ubat dengan konsultasi doktor.", "Saya tidak mengambil bahan terlarang seperti dadah/inhalan/rokok/vape.", "Saya tidak minum minuman beralkohol.", "Saya tidak pernah sakit sepanjang hidup.", "Saya seronok melakukan aktiviti bermakna bersama ahli keluarga.", "Saya sentiasa menjaga hubungan baik dengan ahli keluarga.", "Saya sentiasa memberi sokongan kepada ahli keluarga.", "Saya menerima rakan sebaya seadanya.", "Saya menghormati pandangan rakan sebaya.", "Saya mengambil berat kebajikan rakan sebaya.", "Saya menjaga hubungan baik dengan komuniti setempat.", "Saya menerima kehidupan berkomuniti.", "Saya menerima komuniti setempat saya seadanya.", "Saya tidak pernah berbohong dalam hidup.", "Saya berbincang dengan rakan untuk meningkatkan pengetahuan.", "Saya menguasai bidang pengajian yang dipelajari.", "Saya mencari ilmu pengetahuan untuk meningkatkan pencapaian diri.", "Saya mengenalpasti masalah yang perlu diselesaikan.", "Saya mencari jalan penyelesaian bagi setiap masalah.", "Saya berfikir secara rasional dalam membuat sesuatu keputusan.", "Saya mampu menghasilkan idea baharu dalam pelbagai situasi.", "Saya melihat sesuatu perkara dari berbagai sudut.", "Saya sentiasa meneroka idea baharu.", "Saya tidak pernah rasa kecil hati terhadap sesiapa.", "Saya percaya setiap perkara yang berlaku mempunyai kebaikan disebaliknya.", "Saya menganggap belajar itu sebagai kewajipan.", "Saya melakukan kebaikan dalam kehidupan.", "Saya menghayati nilai murni dalam kehidupan.", "Saya tidak menyalahgunakan kemudahan di institusi pendidikan untuk tujuan peribadi.", "Saya seorang yang amanah.", "Saya boleh dipercayai dalam menjalankan tugas.", "Saya boleh menjalankan tugasan tanpa pengawasan orang lain.", "Saya tidak pernah suka ilmu pengetahuan.", "Saya menerima jantina saya.", "Saya selesa dengan jantina saya.", "Saya menghormati diri saya.", "Saya menghormati kelainan budaya dalam masyarakat.", "Saya boleh melibatkan diri dalam aktiviti silang budaya.", "Saya boleh bertoleransi dengan silang budaya (makanan, pakaian dan gaya hidup).", "Saya berupaya menjalankan tugasan dengan cekap.", "Saya tidak menangguh kerja.", "Saya mampu menyiapkan sesuatu tugasan.", "Saya tidak pernah melakukan tugasan pada saat akhir.", "Saya sedar kepentingan pengurusan kewangan yang bijak.", "Saya tahu kepentingan mengurus perbelanjaan harian.", "Saya mengamalkan sikap menabung.", "Saya mengamalkan sikap berjimat cermat.", "Saya dapati perbelanjaan bulanan mencukupi.", "Saya merancang perbelanjaan saya.", "Saya mempunyai simpanan untuk waktu kecemasan.", "Saya tidak bimbang tentang masalah kewangan.", "Saya tidak pernah berbelanja."
        ];

        // --- SCORING LOGIC FOR IKPSI-P (8 Constructs + Consistency) ---
        const ikpsiScoring = {
            domains: {
                emosi: { label: 'Emosi', items: [1, 2, 3, 4, 5, 6, 7, 8, 9] },
                kendiri: { label: 'Kendiri', items: [11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22] },
                fizikal: { label: 'Fizikal', items: [24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35] },
                perhubungan: { label: 'Perhubungan', items: [37, 38, 39, 40, 41, 42, 43, 44, 45] },
                intelektual: { label: 'Intelektual', items: [47, 48, 49, 50, 51, 52, 53, 54, 55] },
                spiritual: { label: 'Spiritual', items: [57, 58, 59, 60, 61, 62, 63, 64] },
                identiti: { label: 'Identiti', items: [66, 67, 68, 69, 70, 71, 72, 73, 74] },
                kewangan: { label: 'Kewangan', items: [76, 77, 78, 79, 80, 81, 82, 83] }
            },
            consistencyItems: [10, 23, 36, 46, 56, 65, 75, 84],
            getScores: function(responses) {
                const scores = {};
                
                for (const domainKey in this.domains) {
                    const domain = this.domains[domainKey];
                    let totalScore = 0;
                    domain.items.forEach(itemIndex => {
                        totalScore += responses[itemIndex - 1] || 3;
                    });
                    scores[domainKey] = totalScore;
                }
                
                let consistencyScore = 0;
                this.consistencyItems.forEach(itemIndex => {
                    consistencyScore += responses[itemIndex - 1] || 0;
                });
                scores.keselarasan = consistencyScore;

                return scores;
            }
        };

        // --- EVENT HANDLERS & STATE UPDATERS ---
        function startSurvey() {
            state.currentSection = 0;
            render();
            window.scrollTo(0, 0);
        }

        function handleDemographicChange(id, value) {
            const inputElement = document.getElementById(id);
            if (id === 'ic' || id === 'phone') {
                let digitsOnly = value.replace(/\D/g, '');
                if (id === 'ic') {
                    digitsOnly = digitsOnly.slice(0, 12);
                    updateICCounter(digitsOnly);
                }
                state.responses.demographics[id] = digitsOnly;
                if (inputElement) {
                    inputElement.value = digitsOnly;
                }
            } else {
                state.responses.demographics[id] = value;
            }
        }

        function handleGuardianDemographicChange(id, value) {
            const inputElement = document.getElementById(id);
            if (id === 'guardian_phone') {
                let digitsOnly = value.replace(/\D/g, '');
                state.responses.guardianDemographics[id] = digitsOnly;
                if (inputElement) {
                    inputElement.value = digitsOnly;
                }
            } else {
                state.responses.guardianDemographics[id] = value;
            }
        }

        function updateICCounter(icValue) {
            const counterElement = document.getElementById('ic-counter');
            if (counterElement) {
                const length = icValue.length;
                counterElement.textContent = `(${length}/12)`;
                counterElement.className = `absolute inset-y-0 right-0 pr-3 flex items-center text-sm pointer-events-none font-medium ${length === 12 ? 'text-green-600' : 'text-red-500'}`;
            }
        }

        function handlePersonalityChange(index, value) {
            state.responses.personality[index] = parseInt(value);
            updateRadioButtonVisual('personaliti', index, value);
        }

        function handleIkpsiChange(index, value) {
            state.responses.ikpsi[index] = parseInt(value);
            updateRadioButtonVisual('kesejahteraan', index, value);
        }
        
        function updateRadioButtonVisual(section, index, selectedValue) {
            const radioInputs = document.querySelectorAll(`input[name="${section}-${index}"]`);
            radioInputs.forEach(input => {
                const label = document.querySelector(`label[for="${input.id}"]`);
                if (!label) return;

                const baseClass = 'w-8 h-8 sm:w-10 sm:h-10 rounded-full flex items-center justify-center text-sm font-medium transition-all duration-200 cursor-pointer';
                let specificClass = 'bg-gray-200 text-gray-600 hover:bg-gray-300';

                if (parseInt(input.value) === parseInt(selectedValue)) {
                    let colorClass = 'bg-blue-500';
                    if (section === 'kesejahteraan') {
                        colorClass = 'bg-green-500';
                    }
                    specificClass = `${colorClass} text-white shadow-lg transform scale-110`;
                }
                
                label.className = `${baseClass} ${specificClass}`;
            });
        }

        function validateCurrentSection() {
            if (state.currentSection === 0) {
                for (const field of demographicsQuestions) {
                    if (field.required && !state.responses.demographics[field.id]) {
                        return { isValid: false, message: `Sila lengkapkan maklumat: ${field.label}.` };
                    }
                }
                if ((state.responses.demographics.ic || '').length !== 12) {
                    return { isValid: false, message: `No. MyKad mesti mengandungi tepat 12 digit nombor.` };
                }
                const email = state.responses.demographics.email;
                if (email && state.submittedEmails.has(email.toLowerCase())) {
                    return { isValid: false, message: 'Alamat emel ini telah digunakan untuk menjawab soal selidik. Setiap emel hanya boleh digunakan sekali sahaja.' };
                }
            } else if (state.currentSection === 1) {
                for (const field of guardianDemographicsQuestions) {
                    if (field.required && !state.responses.guardianDemographics[field.id]) {
                        return { isValid: false, message: `Sila lengkapkan maklumat: ${field.label}.` };
                    }
                }
            } else if (state.currentSection === 2) {
                if (Object.keys(state.responses.personality).length < personalityQuestions.length) {
                    return { isValid: false, message: 'Sila jawab semua soalan dalam Bahagian C.' };
                }
            } else if (state.currentSection === 3) {
                if (Object.keys(state.responses.ikpsi).length < ikpsiQuestions.length) {
                    return { isValid: false, message: 'Sila jawab semua soalan dalam Bahagian D.' };
                }
            }
            return { isValid: true };
        }

        function handleNextSection() {
            const validation = validateCurrentSection();
            if (!validation.isValid) {
                showModal(validation.message);
                return;
            }
            state.currentSection++;
            render();
            window.scrollTo(0, 0);
        }

        function handlePrevSection() {
            state.currentSection = Math.max(0, state.currentSection - 1);
            render();
            window.scrollTo(0, 0);
        }

        // --- SCORE CALCULATIONS ---
        function calculatePersonalityScores() {
            const r = state.responses.personality;
            const p = (index) => r[index - 1] || 3;
            const reverse = (score) => 6 - score;
            const scores = {
                extraversion: p(1) + reverse(p(6)) + p(11) + reverse(p(16)) + p(21) + reverse(p(26)) + p(31) + reverse(p(36)) + p(41) + reverse(p(46)),
                agreeableness: reverse(p(2)) + p(7) + reverse(p(12)) + p(17) + reverse(p(22)) + p(27) + reverse(p(32)) + p(37) + p(42) + p(47),
                conscientiousness: p(3) + reverse(p(8)) + p(13) + reverse(p(18)) + p(23) + reverse(p(28)) + p(33) + reverse(p(38)) + p(43) + p(48),
                neuroticism: p(4) + reverse(p(9)) + p(14) + reverse(p(19)) + p(24) + p(29) + p(34) + p(39) + p(44) + p(49),
                openness: p(5) + reverse(p(10)) + p(15) + reverse(p(20)) + p(25) + reverse(p(30)) + p(35) + p(40) + p(45) + p(50)
            };
            const toPercent = (score) => Math.round(((score - 10) / 40) * 100);
            return {
                extraversion: toPercent(scores.extraversion),
                agreeableness: toPercent(scores.agreeableness),
                conscientiousness: toPercent(scores.conscientiousness),
                neuroticism: toPercent(scores.neuroticism),
                openness: toPercent(scores.openness)
            };
        }

        function calculateIkpsiScores() {
            return ikpsiScoring.getScores(state.responses.ikpsi);
        }
        
        // --- DATA SUBMISSION & EMAIL (FIXED) ---
        async function showResults() {
            const validation = validateCurrentSection();
            if (!validation.isValid) {
                showModal(validation.message);
                return;
            }

            const submitButton = document.querySelector('button[data-action="show-results"]');
            submitButton.disabled = true;
            submitButton.innerHTML = `<div class="flex items-center justify-center"><svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Memproses & Menghantar E-mel...</div>`;

            const email = state.responses.demographics.email;
            if (email) {
                state.submittedEmails.add(email.toLowerCase());
            }
            
            // First, render the results page so the charts exist in the DOM
            state.showResults = true;
            render();
            window.scrollTo(0, 0);

            // Wait a moment for the DOM to update and charts to render
            setTimeout(async () => {
                try {
                    // Now that charts are visible, gather all data
                    const personalityScores = calculatePersonalityScores();
                    const ikpsiScores = calculateIkpsiScores();
                    const getPersonalityTahap = (score) => (score >= 67 ? 'Tinggi' : score >= 34 ? 'Sederhana' : 'Rendah');
                    const getIkpsiPercent = (score, totalItems) => Math.round(((score - totalItems) / (totalItems * 4)) * 100);
                    const getIkpsiTahap = (percent) => {
                        if (percent >= 80) return 'Tinggi';
                        if (percent >= 60) return 'Sederhana Tinggi';
                        if (percent >= 40) return 'Sederhana';
                        if (percent >= 20) return 'Sederhana Rendah';
                        return 'Rendah';
                    };
                    const getKeselarasanTahap = (score) => (score <= 20 ? 'Selaras' : 'Tidak Selaras');

                    const sheetData = {
                        timestamp: new Date().toLocaleString('en-GB', { timeZone: 'Asia/Kuala_Lumpur' }),
                        ...state.responses.demographics,
                        ...state.responses.guardianDemographics,
                        ...personalityScores,
                        tahap_extraversion: getPersonalityTahap(personalityScores.extraversion),
                        tahap_agreeableness: getPersonalityTahap(personalityScores.agreeableness),
                        tahap_conscientiousness: getPersonalityTahap(personalityScores.conscientiousness),
                        tahap_neuroticism: getPersonalityTahap(personalityScores.neuroticism),
                        tahap_openness: getPersonalityTahap(personalityScores.openness),
                        ...ikpsiScores,
                        tahap_emosi: getIkpsiTahap(getIkpsiPercent(ikpsiScores.emosi, 9)),
                        tahap_kendiri: getIkpsiTahap(getIkpsiPercent(ikpsiScores.kendiri, 12)),
                        tahap_fizikal: getIkpsiTahap(getIkpsiPercent(ikpsiScores.fizikal, 12)),
                        tahap_perhubungan: getIkpsiTahap(getIkpsiPercent(ikpsiScores.perhubungan, 9)),
                        tahap_intelektual: getIkpsiTahap(getIkpsiPercent(ikpsiScores.intelektual, 9)),
                        tahap_spiritual: getIkpsiTahap(getIkpsiPercent(ikpsiScores.spiritual, 8)),
                        tahap_identiti: getIkpsiTahap(getIkpsiPercent(ikpsiScores.identiti, 9)),
                        tahap_kewangan: getIkpsiTahap(getIkpsiPercent(ikpsiScores.kewangan, 8)),
                        tahap_keselarasan: getKeselarasanTahap(ikpsiScores.keselarasan)
                    };

                    // Generate PDF from the visible charts
                    const pdfBase64 = await createPDF('base64');

                    // Combine all data for a single submission
                    const combinedData = {
                        ...sheetData,
                        pdfData: pdfBase64
                    };

                    // Send the combined data to your script
                    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw7L35wqdMIrgJAn-S5e9zNp2LPok9VEsn7WdG_DFfqa-QIZFFftqFgzOLLN5F5xDhA/exec'; 
                    
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(combinedData)
                    });
                    console.log('✅ Combined data (Sheet + Email) sent successfully.');

                } catch (error) {
                    console.error('❌ Error during PDF generation or data submission:', error);
                    showModal("Maaf, terdapat ralat semasa menjana laporan atau menghantar e-mel. Sila muat turun laporan secara manual.");
                }
            }, 500); // 500ms delay to ensure charts are fully rendered
        }


        // --- PDF GENERATION (Refactored) ---
        async function createPDF(outputType = 'download') {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'p', unit: 'pt', format: 'a4' });
            const personalityScores = calculatePersonalityScores();
            const ikpsiScores = calculateIkpsiScores();
            const demographics = state.responses.demographics;
            const guardianDemographics = state.responses.guardianDemographics;
            
            const getPersonalityTahap = (score) => (score >= 67 ? 'Tinggi' : score >= 34 ? 'Sederhana' : 'Rendah');
            const getIkpsiPercent = (score, totalItems) => Math.round(((score - totalItems) / (totalItems * 4)) * 100);
            const getIkpsiTahap = (percent) => {
                if (percent >= 80) return 'Tinggi';
                if (percent >= 60) return 'Sederhana Tinggi';
                if (percent >= 40) return 'Sederhana';
                if (percent >= 20) return 'Sederhana Rendah';
                return 'Rendah';
            };
            const getKeselarasanTahap = (score) => (score <= 20 ? 'Selaras' : 'Tidak Selaras');
            
            const ikpsiPercentScores = {};
            let totalIkpsiPercentSum = 0;
            for (const key in ikpsiScoring.domains) {
                const domain = ikpsiScoring.domains[key];
                const score = ikpsiScores[key];
                const percent = getIkpsiPercent(score, domain.items.length);
                ikpsiPercentScores[key] = percent;
                totalIkpsiPercentSum += percent;
            }
            const overallWellbeingPercent = Math.round(totalIkpsiPercentSum / Object.keys(ikpsiScoring.domains).length);
            const overallWellbeingTahap = getIkpsiTahap(overallWellbeingPercent);
            
            const interpretations = {
                personality: {
                    extraversion: { label: 'Extraversion', Tinggi: 'Sangat suka bersosial, bertenaga, dan cenderung mengalami emosi positif.', Sederhana: 'Keseimbangan antara suka bersosial dan meluangkan masa bersendirian.', Rendah: 'Lebih suka bersendirian, pendiam, dan tidak memerlukan banyak rangsangan sosial.' },
                    agreeableness: { label: 'Agreeableness', Tinggi: 'Cenderung bersimpati, bekerjasama, dan baik hati.', Sederhana: 'Boleh bekerjasama tetapi akan mempertahankan pendirian apabila perlu.', Rendah: 'Lebih kompetitif, analitikal, dan kadangkala skeptikal.' },
                    conscientiousness: { label: 'Conscientiousness', Tinggi: 'Sangat berdisiplin, teratur, dan berorientasikan matlamat.', Sederhana: 'Boleh diharap dan teratur, tetapi juga fleksibel.', Rendah: 'Lebih spontan, fleksibel, dan kadangkala kurang teratur.' },
                    neuroticism: { label: 'Neuroticism', Tinggi: 'Cenderung mengalami emosi negatif seperti marah, cemas, atau tertekan.', Sederhana: 'Secara amnya stabil dari segi emosi tetapi boleh mengalami tekanan.', Rendah: 'Sangat tenang, stabil dari segi emosi, dan berdaya tahan.' },
                    openness: { label: 'Openness', Tinggi: 'Sangat kreatif, ingin tahu, dan terbuka kepada idea-idea baharu.', Sederhana: 'Terbuka kepada perkara baharu tetapi juga menghargai tradisi.', Rendah: 'Lebih praktikal, konvensional, dan lebih suka rutin.' }
                },
                ikpsi: {
                    emosi: { label: 'Emosi', 'Tinggi': 'Kecerdasan emosi sangat baik, mampu mengenali dan mengurus emosi.', 'Sederhana': 'Kesedaran emosi yang baik tetapi ada ruang untuk penambahbaikan.', 'Rendah': 'Mungkin menghadapi kesukaran untuk memahami atau mengurus emosi.'},
                    kendiri: { label: 'Kendiri', 'Tinggi': 'Konsep kendiri yang kukuh, berdikari, dan bertanggungjawab.', 'Sederhana': 'Membina autonomi dan akauntabiliti diri.', 'Rendah': 'Mungkin memerlukan lebih keyakinan dan hala tuju.'},
                    fizikal: { label: 'Fizikal', 'Tinggi': 'Sangat komited terhadap kesihatan fizikal.', 'Sederhana': 'Mengamalkan gaya hidup sihat secara amnya.', 'Rendah': 'Kesihatan fizikal mungkin bukan keutamaan.'},
                    perhubungan: { label: 'Perhubungan', 'Tinggi': 'Mahir membina dan mengekalkan hubungan yang sihat.', 'Sederhana': 'Mempunyai hubungan sosial yang baik.', 'Rendah': 'Mungkin berasa terasing atau menghadapi cabaran sosial.'},
                    intelektual: { label: 'Intelektual', 'Tinggi': 'Rasa ingin tahu yang tinggi, suka belajar, dan pemikiran kritis.', 'Sederhana': 'Menghargai pengetahuan dan keupayaan intelektual yang baik.', 'Rendah': 'Mungkin kurang berminat dalam aktiviti intelektual.'},
                    spiritual: { label: 'Spiritual', 'Tinggi': 'Rasa tujuan dan makna hidup yang mendalam, nilai murni kukuh.', 'Sederhana': 'Meneroka kepercayaan dan nilai, asas moral yang baik.', 'Rendah': 'Mungkin mencari makna atau tujuan dalam hidup.'},
                    identiti: { label: 'Identiti', 'Tinggi': 'Pemahaman yang jelas dan positif tentang identiti diri dan budaya.', 'Sederhana': 'Selesa dengan identiti tetapi mungkin masih meneroka.', 'Rendah': 'Mungkin bergelut dengan penerimaan diri atau identiti budaya.'},
                    kewangan: { label: 'Kewangan', 'Tinggi': 'Sangat cekap mengurus kewangan, bijak merancang dan menabung.', 'Sederhana': 'Tabiat kewangan yang baik tetapi boleh dipertingkatkan.', 'Rendah': 'Mungkin mengalami tekanan kewangan.'}
                }
            };
            
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 40;
            let y = margin;

            const checkPageBreak = (currentY, requiredHeight) => {
                if (currentY + requiredHeight > pageHeight - margin) {
                    doc.addPage();
                    return margin;
                }
                return currentY;
            };

            doc.setFontSize(18); doc.setFont('helvetica', 'bold');
            doc.text('Laporan Profil Kesejahteraan & Personaliti', pageWidth / 2, y, { align: 'center' });
            y += 25; doc.setFontSize(11); doc.setFont('helvetica', 'normal');
            doc.text(`Tarikh: ${new Date().toLocaleDateString('ms-MY')}`, pageWidth / 2, y, { align: 'center' });
            y += 30;

            doc.setFontSize(14); doc.setFont('helvetica', 'bold');
            doc.text('Bahagian A: Maklumat Diri Pelajar', margin, y);
            y += 15;
            doc.autoTable({
                startY: y, theme: 'grid', headStyles: { fillColor: [22, 160, 133] },
                body: [
                    ['Nama Penuh', demographics.name || ''], ['No. MyKad', demographics.ic || ''],
                    ['Email', demographics.email || ''], ['Jantina', demographics.gender || ''],
                    ['Bangsa', demographics.race || ''], ['Agama', demographics.religion || ''],
                    ['No. Telefon', demographics.phone || ''], ['IPG Kampus', demographics.ipgKampus || ''],
                    ['Program', demographics.program || ''], ['Semester', demographics.semester || ''],
                    ['Nama Penjaga', guardianDemographics.guardian_name || ''],
                    ['Pendapatan Isi Rumah', guardianDemographics.guardian_income || '']
                ],
                columnStyles: { 0: { fontStyle: 'bold', cellWidth: 150 } }
            });
            y = doc.autoTable.previous.finalY + 25;

            y = checkPageBreak(y, 60);
            doc.setFontSize(14); doc.setFont('helvetica', 'bold');
            doc.text('Ringkasan Kesejahteraan Menyeluruh', margin, y);
            y += 20; doc.setFontSize(11); doc.setFont('helvetica', 'normal');
            doc.text(`Tahap Kesejahteraan Keseluruhan Anda ialah `, margin, y);
            doc.setFont('helvetica', 'bold');
            const tahapTextWidth = doc.getTextWidth(`Tahap Kesejahteraan Keseluruhan Anda ialah `);
            doc.text(`${overallWellbeingTahap} (${overallWellbeingPercent}%)`, margin + tahapTextWidth, y);
            y += 20;
            const keselarasanTahap = getKeselarasanTahap(ikpsiScores.keselarasan);
            doc.text(`Status Keselarasan Jawapan: ${keselarasanTahap} (Skor: ${ikpsiScores.keselarasan})`, margin, y);
            y += 25;

            y = checkPageBreak(y, 300 + 150);
            doc.setFontSize(14); doc.setFont('helvetica', 'bold');
            doc.text('Bahagian B: Profil Personaliti (Big Five)', margin, y);
            y += 20;
            const personalityChartCanvas = document.getElementById('personalityChart');
            const personalityChartImage = await html2canvas(personalityChartCanvas, { scale: 3 });
            doc.addImage(personalityChartImage.toDataURL('image/png'), 'PNG', margin, y, 515, 250);
            y += 270;

            doc.autoTable({
                startY: y, theme: 'striped', headStyles: { fillColor: [41, 128, 185] },
                head: [['Domain Personaliti', 'Skor (%)', 'Tahap', 'Interpretasi Ringkas']],
                body: Object.keys(personalityScores).map(key => {
                    const score = personalityScores[key];
                    const tahap = getPersonalityTahap(score);
                    const interp = interpretations.personality[key];
                    return [interp.label, score, tahap, interp[tahap]];
                }),
                columnStyles: { 3: { cellWidth: 'auto' } }
            });
            y = doc.autoTable.previous.finalY;
            
            doc.addPage();
            y = margin;
            doc.setFontSize(14); doc.setFont('helvetica', 'bold');
            doc.text('Bahagian C: Profil Kesejahteraan (IKPSI-P)', margin, y);
            y += 20;
            const ikpsiChartCanvas = document.getElementById('ikpsiChart');
            const ikpsiChartImage = await html2canvas(ikpsiChartCanvas, { scale: 3 });
            doc.addImage(ikpsiChartImage.toDataURL('image/png'), 'PNG', margin, y, 515, 250);
            y += 270;

            doc.autoTable({
                startY: y, theme: 'striped', headStyles: { fillColor: [39, 174, 96] },
                head: [['Domain Kesejahteraan', 'Skor (%)', 'Tahap', 'Interpretasi Ringkas']],
                body: Object.keys(ikpsiScoring.domains).map(key => {
                    const percent = ikpsiPercentScores[key];
                    const tahap = getIkpsiTahap(percent);
                    const interp = interpretations.ikpsi[key];
                    return [interp.label, percent, tahap, interp[tahap]];
                }),
                columnStyles: { 3: { cellWidth: 'auto' } }
            });
            y = doc.autoTable.previous.finalY + 40;
            
            y = checkPageBreak(y, 120);
            doc.setFontSize(9); doc.setFont('helvetica', 'italic');
            doc.text('Nota: Laporan ini adalah berdasarkan maklum balas anda dan bertujuan untuk pembangunan diri.', margin, y);
            y += 12;
            doc.text('Jika anda ingin mendapatkan maklumat lanjut berkaitan PKPP, sila berjumpa Kaunselor Pendidikan di IPG masing-masing.', margin, y);
            y += 80;

            doc.setFont('helvetica', 'normal');
            doc.text('...................................................................', margin, y);
            y += 15; doc.text('Tandatangan Kaunselor', margin, y);
            y += 15; doc.text('Nama:', margin, y);
            y += 15; doc.text('Tarikh:', margin, y);

            if (outputType === 'base64') {
                return doc.output('datauristring');
            } else {
                doc.save(`Laporan_Profil_${demographics.name.replace(/ /g, '_')}.pdf`);
            }
        }

        async function downloadPDF() {
            const pdfButton = document.getElementById('pdf-button');
            pdfButton.disabled = true;
            pdfButton.innerHTML = `<div class="flex items-center justify-center"><svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Menjana PDF...</div>`;
            await createPDF('download');
            pdfButton.disabled = false;
            pdfButton.innerHTML = `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg> Muat Turun Semula PDF`;
        }

        // --- RENDER FUNCTIONS ---
        function render() {
            const app = document.getElementById('app');
            app.className = "max-w-4xl mx-auto p-4 sm:p-6 lg:p-8 bg-white min-h-screen shadow-lg rounded-lg fade-in";
            
            if (state.showResults) {
                app.innerHTML = renderResults();
                setTimeout(() => {
                    renderPersonalityChart();
                    renderIkpsiChart();
                }, 100);
            } else if (state.currentSection === -1) {
                app.innerHTML = renderWelcomeScreen();
            } else {
                let content = '';
                switch(state.currentSection) {
                    case 0: content = renderDemographics(); break;
                    case 1: content = renderGuardianDemographics(); break;
                    case 2: content = renderQuestionnaire('personaliti', 'C', personalityQuestions, state.responses.personality); break;
                    case 3: content = renderQuestionnaire('kesejahteraan', 'D', ikpsiQuestions, state.responses.ikpsi); break;
                }
                app.innerHTML = renderProgressBar() + content;
            }
        }

        function renderProgressBar() {
            const totalSections = 4;
            const progress = ((state.currentSection + 1) / totalSections) * 100;
            const sectionTitles = ['Maklumat Diri', 'Maklumat Penjaga', 'Soal Selidik Personaliti', 'Soal Selidik Kesejahteraan'];
            return `
                <div class="mb-8">
                    <h2 class="text-xl font-bold text-gray-700 mb-1">Langkah ${state.currentSection + 1} dari ${totalSections}</h2>
                    <p class="text-gray-500 mb-3">${sectionTitles[state.currentSection]}</p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div class="bg-blue-600 h-2.5 rounded-full progress-bar-animated" style="width: ${progress}%"></div>
                    </div>
                </div>
            `;
        }

        function renderWelcomeScreen() {
            return `
                <div class="text-center py-10 px-4 welcome-card bg-white rounded-lg">
                    <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-4">Selamat Datang!</h1>
                    <p class="text-md sm:text-lg text-gray-600 max-w-2xl mx-auto mb-6">
                        Soal selidik ini bertujuan untuk membantu anda memahami profil personaliti dan tahap kesejahteraan diri anda. Jawapan anda adalah sulit dan akan digunakan untuk tujuan pembangunan diri.
                    </p>
                    <p class="text-md sm:text-lg text-gray-600 max-w-2xl mx-auto mb-8">
                        Sila jawab semua soalan dengan jujur. Tiada jawapan yang betul atau salah.
                    </p>
                    <button data-action="start-survey" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 shadow-lg">
                        Mulakan Soal Selidik
                    </button>
                </div>
            `;
        }
        
        function renderDemographics() {
            const fields = demographicsQuestions.map(q => {
                const value = state.responses.demographics[q.id] || '';
                if (q.type === 'select') {
                    return `
                        <div class="mb-4">
                            <label for="${q.id}" class="block text-gray-700 text-sm font-bold mb-2">${q.label}${q.required ? '<span class="text-red-500">*</span>' : ''}</label>
                            <select id="${q.id}" data-action="demographic-input" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                <option value="">Sila Pilih...</option>
                                ${q.options.map(opt => `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                            </select>
                        </div>
                    `;
                }
                const icCounter = q.id === 'ic' ? `<span id="ic-counter" class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm pointer-events-none font-medium text-red-500">(0/12)</span>` : '';
                return `
                    <div class="mb-4 relative">
                        <label for="${q.id}" class="block text-gray-700 text-sm font-bold mb-2">${q.label}${q.required ? '<span class="text-red-500">*</span>' : ''}</label>
                        <input type="${q.type}" id="${q.id}" value="${value}" data-action="demographic-input"
                               ${q.maxLength ? `maxlength="${q.maxLength}"` : ''} ${q.pattern ? `pattern="${q.pattern}"` : ''}
                               class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        ${icCounter}
                    </div>
                `;
            }).join('');

            return `
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-4">Bahagian A: Maklumat Diri Pelajar</h2>
                    ${fields}
                </div>
                ${renderNavigationButtons()}
            `;
        }

        function renderGuardianDemographics() {
             const fields = guardianDemographicsQuestions.map(q => {
                const value = state.responses.guardianDemographics[q.id] || '';
                if (q.type === 'select') {
                    return `
                        <div class="mb-4">
                            <label for="${q.id}" class="block text-gray-700 text-sm font-bold mb-2">${q.label}${q.required ? '<span class="text-red-500">*</span>' : ''}</label>
                            <select id="${q.id}" data-action="guardian-input" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                                <option value="">Sila Pilih...</option>
                                ${q.options.map(opt => `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                            </select>
                        </div>
                    `;
                }
                return `
                    <div class="mb-4">
                        <label for="${q.id}" class="block text-gray-700 text-sm font-bold mb-2">${q.label}${q.required ? '<span class="text-red-500">*</span>' : ''}</label>
                        <input type="${q.type}" id="${q.id}" value="${value}" data-action="guardian-input"
                               class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                `;
            }).join('');

            return `
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-4">Bahagian B: Maklumat Ibu/Bapa/Penjaga</h2>
                    ${fields}
                </div>
                ${renderNavigationButtons()}
            `;
        }

        function renderQuestionnaire(type, sectionLetter, questions, responses) {
            const scaleLabels = ['Sangat Tidak Setuju', 'Tidak Setuju', 'Tidak Pasti', 'Setuju', 'Sangat Setuju'];
            const questionsHtml = questions.map((q, index) => {
                const radioButtons = [1, 2, 3, 4, 5].map(value => {
                    const isChecked = responses[index] === value;
                    const sectionType = (type === 'personaliti') ? 'personaliti' : 'kesejahteraan';
                    let colorClass = 'bg-blue-500';
                    if (type === 'kesejahteraan') colorClass = 'bg-green-500';

                    const labelClass = isChecked 
                        ? `${colorClass} text-white shadow-lg transform scale-110` 
                        : 'bg-gray-200 text-gray-600 hover:bg-gray-300';

                    return `
                        <div class="flex flex-col items-center mx-1 sm:mx-2">
                            <input type="radio" id="${sectionType}-${index}-${value}" name="${sectionType}-${index}" value="${value}" class="sr-only" 
                                   data-action="answer-question" data-section-type="${sectionType}" data-question-index="${index}" ${isChecked ? 'checked' : ''}>
                            <label for="${sectionType}-${index}-${value}" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full flex items-center justify-center text-sm font-medium transition-all duration-200 cursor-pointer ${labelClass}">
                                ${value}
                            </label>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="py-5 px-4 mb-3 bg-gray-50 rounded-lg border border-gray-200 transition-shadow hover:shadow-md">
                        <p class="text-gray-800 font-medium mb-4 text-center sm:text-left">${index + 1}. ${q}</p>
                        <div class="flex justify-around items-center radio-container">
                            ${radioButtons}
                        </div>
                    </div>
                `;
            }).join('');

            return `
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Bahagian ${sectionLetter}: Soal Selidik ${type.charAt(0).toUpperCase() + type.slice(1)}</h2>
                    <div class="flex flex-col sm:flex-row justify-between text-xs text-gray-500 font-medium mb-6 px-4">
                        ${scaleLabels.map(label => `<span>${label}</span>`).join('')}
                    </div>
                    ${questionsHtml}
                </div>
                ${renderNavigationButtons()}
            `;
        }

        function renderNavigationButtons() {
            const isFirstSection = state.currentSection === 0;
            const isLastSection = state.currentSection === 3;

            const prevButton = isFirstSection ? '' : `
                <button data-action="prev-section" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600 transition-colors">
                    Kembali
                </button>
            `;

            const nextButton = isLastSection ? `
                <button data-action="show-results" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 transition-colors">
                    Hantar & Lihat Keputusan
                </button>
            ` : `
                <button data-action="next-section" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">
                    Seterusnya
                </button>
            `;

            return `
                <div class="flex justify-between mt-8">
                    ${prevButton}
                    <div class="ml-auto">${nextButton}</div>
                </div>
            `;
        }

        function renderResults() {
            const ikpsiScores = calculateIkpsiScores();
            const getIkpsiPercent = (score, totalItems) => Math.round(((score - totalItems) / (totalItems * 4)) * 100);
            const getIkpsiTahap = (percent) => {
                if (percent >= 80) return 'Tinggi';
                if (percent >= 60) return 'Sederhana Tinggi';
                if (percent >= 40) return 'Sederhana';
                if (percent >= 20) return 'Sederhana Rendah';
                return 'Rendah';
            };
            let totalIkpsiPercentSum = 0;
            for (const key in ikpsiScoring.domains) {
                const domain = ikpsiScoring.domains[key];
                const score = ikpsiScores[key];
                const percent = getIkpsiPercent(score, domain.items.length);
                totalIkpsiPercentSum += percent;
            }
            const overallWellbeingPercent = Math.round(totalIkpsiPercentSum / Object.keys(ikpsiScoring.domains).length);
            const overallWellbeingTahap = getIkpsiTahap(overallWellbeingPercent);
            const getTahapColor = (tahap) => {
                switch(tahap) {
                    case 'Tinggi': case 'Sederhana Tinggi': return 'text-green-600 bg-green-100';
                    case 'Sederhana': return 'text-yellow-600 bg-yellow-100';
                    case 'Sederhana Rendah': case 'Rendah': return 'text-red-600 bg-red-100';
                    default: return 'text-gray-600 bg-gray-100';
                }
            };
            
            const keselarasanTahap = ikpsiScores.keselarasan <= 20 ? 'Selaras' : 'Tidak Selaras';
            const keselarasanColor = keselarasanTahap === 'Selaras' ? 'text-green-600 bg-green-100' : 'text-red-600 bg-red-100';

            return `
                <div id="results-container">
                    <div class="text-center border-b pb-6 mb-6">
                        <h1 class="text-3xl font-bold text-gray-800">Laporan Keputusan Anda</h1>
                        <p class="text-gray-600 mt-2">Terima kasih kerana melengkapkan soal selidik ini.</p>
                    </div>
                    
                    <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-lg mb-6 no-print">
                        <div class="flex">
                            <div class="py-1"><svg class="h-6 w-6 text-green-500 mr-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg></div>
                            <div>
                                <p class="font-bold">Laporan Dihantar</p>
                                <p class="text-sm">Salinan laporan PDF telah dihantar ke emel anda: <strong>${state.responses.demographics.email}</strong>. Sila semak peti masuk anda.</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 no-print">
                        <button id="pdf-button" data-action="download-pdf" class="w-full bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 transition-colors shadow-md flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            Muat Turun Semula PDF
                        </button>
                         <button data-action="restart-survey" class="w-full bg-gray-200 text-gray-800 font-bold py-3 px-6 rounded-lg hover:bg-gray-300 transition-colors shadow-md flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 4l16 16"></path></svg>
                            Jawab Semula
                        </button>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="bg-blue-50 border-l-4 border-blue-500 p-6 rounded-lg">
                            <h2 class="text-xl font-bold text-blue-800 mb-2">Kesejahteraan Menyeluruh</h2>
                            <p class="text-lg text-blue-700">Tahap Anda: 
                                <span class="font-extrabold px-3 py-1 rounded-md ${getTahapColor(overallWellbeingTahap)}">${overallWellbeingTahap} (${overallWellbeingPercent}%)</span>
                            </p>
                        </div>
                        <div class="bg-purple-50 border-l-4 border-purple-500 p-6 rounded-lg">
                            <h2 class="text-xl font-bold text-purple-800 mb-2">Keselarasan Jawapan</h2>
                            <p class="text-lg text-purple-700">Status Anda: 
                                <span class="font-extrabold px-3 py-1 rounded-md ${keselarasanColor}">${keselarasanTahap}</span>
                            </p>
                            <p class="text-xs text-purple-600 mt-2">(Skor: ${ikpsiScores.keselarasan}. Skor rendah menunjukkan jawapan yang selaras.)</p>
                        </div>
                    </div>
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Profil Personaliti (Big Five)</h2>
                        <div class="bg-white p-4 rounded-lg shadow-md border" style="height: 350px;">
                            <canvas id="personalityChart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Profil Kesejahteraan (IKPSI-P)</h2>
                        <div class="bg-white p-4 rounded-lg shadow-md border" style="height: 350px;">
                             <canvas id="ikpsiChart"></canvas>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderPersonalityChart() {
            const ctx = document.getElementById('personalityChart')?.getContext('2d');
            if (!ctx) return;
            const scores = calculatePersonalityScores();
            new Chart(ctx, {
                type: 'bar', data: {
                    labels: ['Extraversion', 'Agreeableness', 'Conscientiousness', 'Neuroticism', 'Openness'],
                    datasets: [{
                        label: 'Skor Personaliti (%)', data: Object.values(scores),
                        backgroundColor: ['rgba(54, 162, 235, 0.5)','rgba(255, 99, 132, 0.5)','rgba(75, 192, 192, 0.5)','rgba(255, 206, 86, 0.5)','rgba(153, 102, 255, 0.5)'],
                        borderColor: ['rgba(54, 162, 235, 1)','rgba(255, 99, 132, 1)','rgba(75, 192, 192, 1)','rgba(255, 206, 86, 1)','rgba(153, 102, 255, 1)'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, indexAxis: 'y',
                    scales: { x: { beginAtZero: true, suggestedMax: 100 } },
                    plugins: { legend: { display: false }, title: { display: true, text: 'Graf Bar Personaliti Big Five' } }
                }
            });
        }

        function renderIkpsiChart() {
            const ctx = document.getElementById('ikpsiChart')?.getContext('2d');
            if (!ctx) return;
            const scores = calculateIkpsiScores();
            const getIkpsiPercent = (score, totalItems) => Math.round(((score - totalItems) / (totalItems * 4)) * 100);
            const dataPoints = Object.keys(ikpsiScoring.domains).map(key => getIkpsiPercent(scores[key], ikpsiScoring.domains[key].items.length));
            new Chart(ctx, {
                type: 'radar', data: {
                    labels: Object.values(ikpsiScoring.domains).map(d => d.label),
                    datasets: [{
                        label: 'Skor Kesejahteraan (%)', data: dataPoints,
                        backgroundColor: 'rgba(39, 174, 96, 0.2)', borderColor: 'rgba(39, 174, 96, 1)',
                        borderWidth: 2, pointBackgroundColor: 'rgba(39, 174, 96, 1)',
                        pointBorderColor: '#fff', pointHoverBackgroundColor: '#fff', pointHoverBorderColor: 'rgba(39, 174, 96, 1)'
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { r: { angleLines: { display: true }, suggestedMin: 0, suggestedMax: 100, pointLabels: { font: { size: 11, weight: 'bold' } } } },
                    plugins: { legend: { position: 'top' }, title: { display: true, text: 'Graf Radar Domain Kesejahteraan (IKPSI-P)' } }
                }
            });
        }

        // --- MODAL FUNCTIONS ---
        function showModal(message) {
            const modalHTML = `
                <div id="alert-modal" class="modal-backdrop visible">
                    <div class="modal-content">
                        <h3 class="text-lg font-bold text-yellow-600 mb-4">Perhatian!</h3>
                        <p class="text-gray-700 mb-6">${message}</p>
                        <button data-action="close-modal" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">Faham</button>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').innerHTML = modalHTML;
            document.querySelector('button[data-action="close-modal"]').focus();
        }

        function closeModal() {
            const modal = document.getElementById('alert-modal');
            if (modal) {
                modal.classList.remove('visible');
                setTimeout(() => {
                    document.getElementById('modal-container').innerHTML = '';
                }, 300);
            }
        }

        // --- INITIAL SETUP ---
        document.addEventListener('DOMContentLoaded', () => {
            const app = document.getElementById('app');

            // Master event listener for all clicks
            document.body.addEventListener('click', (e) => {
                const target = e.target.closest('[data-action]');
                if (!target) return;
                
                const action = target.dataset.action;

                switch (action) {
                    case 'start-survey': startSurvey(); break;
                    case 'next-section': handleNextSection(); break;
                    case 'prev-section': handlePrevSection(); break;
                    case 'show-results': showResults(); break;
                    case 'download-pdf': downloadPDF(); break;
                    case 'restart-survey': location.reload(); break;
                    case 'close-modal': closeModal(); break;
                }
            });

            // Master event listener for form element changes and inputs
            app.addEventListener('change', (e) => {
                const target = e.target;
                if (!target.dataset.action) return;
                const action = target.dataset.action;

                if (action === 'answer-question') {
                    const sectionType = target.dataset.sectionType;
                    const questionIndex = parseInt(target.dataset.questionIndex, 10);
                    const value = parseInt(target.value, 10);
                    if (sectionType === 'personaliti') {
                        handlePersonalityChange(questionIndex, value);
                    } else if (sectionType === 'kesejahteraan') {
                        handleIkpsiChange(questionIndex, value);
                    }
                } else if (target.tagName === 'SELECT') {
                    if (action === 'demographic-input') handleDemographicChange(target.id, target.value);
                    if (action === 'guardian-input') handleGuardianDemographicChange(target.id, target.value);
                }
            });
            
            app.addEventListener('input', (e) => {
                const target = e.target;
                if (target.tagName === 'INPUT' && target.dataset.action) {
                    const action = target.dataset.action;
                    if (action === 'demographic-input') handleDemographicChange(target.id, target.value);
                    if (action === 'guardian-input') handleGuardianDemographicChange(target.id, target.value);
                }
            });

            render();
        });
    </script>
</body>
</html>
